# 다음결제일 파싱 로직 분석

## 무한루프 위험성

```
┌─────────────────────────────────────────────────────────────┐
│  문제 시나리오                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [일시중지 실행]                                             │
│       ↓                                                     │
│  [팝업에서 날짜 추출 실패] ← 정규식 매칭 안됨                  │
│       ↓                                                     │
│  nextBillingDate = null                                     │
│       ↓                                                     │
│  [F열(다음결제일) 업데이트 안됨] ← 예전 날짜 그대로            │
│       ↓                                                     │
│  상태는 "일시중지" → "결제중" 변경됨                          │
│       ↓                                                     │
│  [30분 후] 워커가 다시 체크                                   │
│       ↓                                                     │
│  F열의 예전 날짜가 여전히 "과거"이므로                        │
│       ↓                                                     │
│  다시 일시중지 대상으로 선택됨 ← 무한루프!                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 날짜 파싱 전체 흐름 (3단계)

```
┌──────────────────────────────────────────────────────────────┐
│  1단계: 팝업 텍스트에서 날짜 추출 (정규식)                      │
│  ───────────────────────────────────────────                 │
│  "Your membership will be paused after Jan 26"              │
│                                          ↓                  │
│                                     "Jan 26" 추출            │
├──────────────────────────────────────────────────────────────┤
│  2단계: 어떤 날짜가 "다음결제일"인지 결정 (언어별 로직)          │
│  ───────────────────────────────────────────                 │
│  날짜 2개: ["Jan 26", "Feb 26"]                              │
│       ↓                                                     │
│  영어: 더 가까운 날짜 = 다음결제일                             │
│       ↓                                                     │
│  nextBillingDate = "Jan 26"                                 │
│  resumeDate = "Feb 26"                                      │
├──────────────────────────────────────────────────────────────┤
│  3단계: 날짜 텍스트를 YYYY-MM-DD로 변환 (parseDate)            │
│  ───────────────────────────────────────────                 │
│  "Jan 26" → "2026-01-26"                                    │
│       ↓                                                     │
│  F열에 저장: 2026-01-26                                      │
└──────────────────────────────────────────────────────────────┘
```

---

## 1단계: 팝업에서 날짜 추출 (정규식)

### 파일 위치
`EnhancedPauseSubscriptionUseCase.js:2711-2750`

### 언어별 정규식 패턴

| 언어 | YouTube 팝업 예시 | 정규식 | 추출 결과 |
|------|------------------|--------|-----------|
| **영어** | "paused after **Jan 26**" | `/(Jan\|Feb\|Mar...)\.?\s+\d{1,2}/gi` | `Jan 26` |
| **영어** | "paused after **January 26**" | `/(January\|February...)s+\d{1,2}/gi` | `January 26` |
| **한국어** | "**1월 26일**에 일시중지" | `/\d{1,2}월\s*\d{1,2}일/g` | `1월 26일` |
| **한국어** | "**2026. 1. 26.**에 일시중지" | `/\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.?/g` | `2026. 1. 26.` |
| **러시아어** | "**26 января** приостановлена" | `/\d{1,2}\s+(января\|февраля...)/gi` | `26 января` |
| **러시아어** | "**26 янв. 2026г.**" | `/\d{1,2}\s+(янв\|февр...)\.?\s*\d{4}\s*г?\.?/gi` | `26 янв. 2026г.` |

### 현재 지원하는 패턴 (datePatterns 배열)

```javascript
// 영어
/(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2}/gi
/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\.?\s+\d{1,2}/gi

// 한국어
/\d{1,2}월\s*\d{1,2}일/g                    // 1월 26일
/\d{4}년\s*\d{1,2}월\s*\d{1,2}일/g          // 2026년 1월 26일
/\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.?/g         // 2026. 1. 26.

// 러시아어 - 전체 월명
/\d{1,2}\s+(января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|ноября|декабря)/gi

// 러시아어 - 약어 + 연도
/\d{1,2}\s+(янв|февр|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек)\.?\s*\d{4}\s*г?\.?/gi

// 러시아어 - 약어만
/\d{1,2}\s+(янв|февр|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек)\.?/gi
```

---

## 2단계: 어떤 날짜가 "다음결제일"인지 결정

### 파일 위치
`EnhancedPauseSubscriptionUseCase.js:2940-3088`

### 언어별 처리 로직

| 언어 | 날짜 2개 있을 때 처리 방식 | 비고 |
|------|---------------------------|------|
| **한국어 (ko)** | 첫 번째 = 다음결제일, 두 번째 = 재개일 | 고정 순서 |
| **영어 (en)** | 더 가까운 날짜 = 다음결제일 | 날짜 비교 |
| **러시아어 (ru)** | 더 가까운 날짜 = 다음결제일 | 날짜 비교 |
| **기타 언어** | 더 가까운 날짜 = 다음결제일 | 날짜 비교 |

### 날짜가 1개만 있을 때
→ 그 날짜를 **다음결제일**로 사용

### 날짜가 0개일 때
→ **nextBillingDate = null** (F열 업데이트 안됨) → **무한루프 위험!**

---

## 3단계: 날짜 텍스트 → YYYY-MM-DD 변환

### 파일 위치
`EnhancedDateParsingService.js:186-248`

### 지원하는 변환 패턴

| 패턴 타입 | 예시 입력 | 출력 |
|-----------|-----------|------|
| ISO | `2026-01-26` | `2026-01-26` |
| KoreanDot | `2026. 1. 26.` | `2026-01-26` |
| Korean | `2026년 1월 26일` | `2026-01-26` |
| KoreanShort | `1월 26일` | `2026-01-26` (현재 연도) |
| US | `Jan 26, 2026` | `2026-01-26` |
| USShort | `Jan 26` | `2026-01-26` (현재 연도) |
| RussianFull | `26 янв. 2026 г.` | `2026-01-26` |
| RussianShort | `26 янв.` | `2026-01-26` (현재 연도) |
| Russian | `26 января 2026` | `2026-01-26` |

### 월 이름 매핑 (monthMappings)

```javascript
// 영어
en: { 'January': 1, 'Jan': 1, 'February': 2, 'Feb': 2, ... }

// 한국어
ko: { '1월': 1, '2월': 2, '3월': 3, ... }

// 러시아어 (축약형 포함)
ru: {
  'январь': 1, 'января': 1, 'янв': 1,
  'февраль': 2, 'февраля': 2, 'фев': 2, 'февр': 2,  // февр 추가됨
  'март': 3, 'марта': 3, 'мар': 3,
  ...
}
```

---

## 실패 케이스 분석

### 케이스 1: 정규식 매칭 실패

```
팝업 텍스트: "26 февр. 2026г." (러시아어 약어)
기존 정규식: /\d{1,2}\s+(января|февраля|...)/  ← 전체 월명만!
결과: 매칭 실패 → 날짜 추출 안됨
```

**해결됨**: `февр` 약어 패턴 추가 (2024-12-25 수정)

### 케이스 2: 한국어 점 형식

```
팝업 텍스트: "2026. 1. 26.에 일시중지됩니다"
기존 정규식: 없었음
결과: 매칭 실패
```

**해결됨**: `/\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.?/g` 패턴 추가

### 케이스 3: 연도 없는 날짜

```
팝업 텍스트: "Jan 26" (연도 없음)
parseDate 처리: 현재 연도 또는 다음 연도 자동 추론
```

**정상 작동**: 현재 월보다 이전 월이면 다음 연도로 처리

---

## 무한루프 방지 전략

### 현재 구현된 방지책

1. **H열(결과)에 기록**: 성공/실패 시 결과가 기록됨
2. **L열(재시도) 제한**: 3회 실패 시 스킵

### 추가 권장 방지책

1. **날짜 파싱 실패 시 상태 변경하지 않기**
   - nextBillingDate가 null이면 E열 상태를 "결제중"으로 바꾸지 않음
   - 현재: 상태는 바꾸고 날짜만 안 바꿈 → 문제 발생

2. **실패 시 명시적 마킹**
   - 날짜 파싱 실패 시 H열에 "날짜파싱실패" 기록
   - 다음 사이클에서 자동 건너뛰기

3. **F열 유효성 검사**
   - 통합워커가 F열 날짜가 유효한지 검사
   - 이미 처리된 날짜(과거+1달 이상)면 스킵

---

## 디버깅 방법

### 로그 확인

일시중지 실행 시 다음 로그가 출력됩니다:

```
팝업에서 추출된 날짜: Jan 26, Feb 26
🇺🇸 영어 패턴: 다음결제일="Jan 26", 재개일="Feb 26"
✅ 다음 결제일(일시정지일) 파싱: Jan 26 → 2026-01-26
```

### 파싱 실패 시 로그

```
팝업에서 날짜를 찾지 못함 - 팝업 내용 확인 필요
```

### 디버그 모드 활성화

```
? 디버그 모드 활성화? Yes
```

팝업 내용 샘플이 출력되어 어떤 형식의 날짜가 있는지 확인 가능

---

## 요약

| 단계 | 파일 | 실패 시 결과 |
|------|------|-------------|
| 1. 날짜 추출 | EnhancedPauseSubscriptionUseCase.js | dates = [] |
| 2. 날짜 선택 | EnhancedPauseSubscriptionUseCase.js | nextBillingDate = null |
| 3. 날짜 변환 | EnhancedDateParsingService.js | parseDate() = null |
| 4. 시트 저장 | PauseSheetRepository.js | F열 업데이트 안됨 |
| → | | **무한루프 위험** |

**핵심**: 정규식 패턴이 YouTube 팝업 텍스트와 일치하지 않으면 모든 것이 실패합니다.
