/**
 * Working Authentication Service
 * ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ” Google ë¡œê·¸ì¸ ì„œë¹„ìŠ¤
 * - ê³„ì • ì„ íƒ í˜ì´ì§€ í´ë¦­ ë¬¸ì œë¥¼ URL ì¡°ì‘ìœ¼ë¡œ ìš°íšŒ
 */

const chalk = require('chalk');

class WorkingAuthenticationService {
  constructor(options = {}) {
    this.debugMode = options.debugMode || false;
  }

  log(message, type = 'info') {
    if (!this.debugMode) return;
    
    const prefix = '[WorkingAuth]';
    const formattedMessage = `${prefix} ${message}`;
    
    switch(type) {
      case 'success':
        console.log(chalk.green(formattedMessage));
        break;
      case 'error':
        console.log(chalk.red(formattedMessage));
        break;
      case 'warning':
        console.log(chalk.yellow(formattedMessage));
        break;
      default:
        console.log(chalk.cyan(formattedMessage));
    }
  }

  /**
   * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
   */
  async checkLoginStatus(page) {
    try {
      const currentUrl = page.url();
      
      // ë¡œê·¸ì¸ í˜ì´ì§€ì¸ì§€ í™•ì¸
      if (currentUrl.includes('accounts.google.com')) {
        this.log('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ìƒíƒœ', 'warning');
        return false;
      }
      
      // YouTubeì—ì„œ ë¡œê·¸ì¸ í™•ì¸
      if (currentUrl.includes('youtube.com')) {
        const isLoggedIn = await page.evaluate(() => {
          // ì•„ë°”íƒ€ ë²„íŠ¼ í™•ì¸
          const avatarBtn = document.querySelector('#avatar-btn, button#avatar-btn');
          if (avatarBtn) return true;
          
          // ë¡œê·¸ì¸ ë§í¬ê°€ ì—†ëŠ”ì§€ í™•ì¸
          const signInLink = document.querySelector('a[href*="ServiceLogin"]');
          if (!signInLink) return true;
          
          // í˜ì´ì§€ í…ìŠ¤íŠ¸ í™•ì¸
          const pageText = document.body?.innerText || '';
          const hasManageButton = pageText.includes('Manage membership') || 
                                 pageText.includes('êµ¬ë… ê´€ë¦¬') ||
                                 pageText.includes('ê´€ë¦¬');
          if (hasManageButton) return true;
          
          return false;
        });
        
        if (isLoggedIn) {
          this.log('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨', 'success');
        } else {
          this.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ', 'warning');
        }
        
        return isLoggedIn;
      }
      
      return true;
    } catch (error) {
      this.log(`ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      return false;
    }
  }

  /**
   * ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬ (URL ì¡°ì‘ ë°©ì‹)
   */
  async handleAccountChooser(page, email) {
    try {
      this.log('ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬ ì‹œì‘', 'info');
      
      const currentUrl = page.url();
      const url = new URL(currentUrl);
      const params = new URLSearchParams(url.search);
      
      // ì„¸ì…˜ ì •ë³´ ì¶”ì¶œ
      const sessionInfo = await page.evaluate((targetEmail) => {
        const accounts = [];
        document.querySelectorAll('[data-identifier]').forEach(el => {
          const email = el.getAttribute('data-identifier');
          const parent = el.closest('li');
          if (parent) {
            accounts.push({
              email,
              text: parent.innerText
            });
          }
        });
        
        return {
          accounts,
          hasTargetAccount: accounts.some(acc => acc.email === targetEmail)
        };
      }, email);
      
      this.log(`ë°œê²¬ëœ ê³„ì •: ${sessionInfo.accounts.length}ê°œ`, 'info');
      sessionInfo.accounts.forEach(acc => {
        this.log(`  - ${acc.email}`, 'info');
      });
      
      if (sessionInfo.hasTargetAccount) {
        this.log(`${email} ê³„ì • ë°œê²¬ - ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì§„í–‰ ì‹œë„`, 'success');
        
        // ë°©ë²• 1: "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ í´ë¦­
        try {
          this.log('ë°©ë²• 1: "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ í´ë¦­ ì‹œë„', 'info');
          
          // "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ ì°¾ê¸° (ì—¬ëŸ¬ ì…€ë ‰í„° ì‹œë„)
          const useAnotherSelectors = [
            'div[data-identifier=""]',  // ë¹ˆ identifierë¥¼ ê°€ì§„ div
            '[aria-label*="ë‹¤ë¥¸ ê³„ì •"]',
            '[aria-label*="Use another account"]',
            'li:has-text("ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©")',
            'li:has-text("Use another account")',
            'div:has-text("ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©")',
            '[role="link"]:has-text("ë‹¤ë¥¸")',
            'li[class*="JDAKTe"] div[data-identifier=""]'  // Googleì˜ í´ë˜ìŠ¤ëª… íŒ¨í„´
          ];
          
          let useAnotherButton = null;
          for (const selector of useAnotherSelectors) {
            try {
              useAnotherButton = await page.$(selector);
              if (useAnotherButton) {
                this.log(`"ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ ì°¾ìŒ: ${selector}`, 'success');
                break;
              }
            } catch (e) {
              // ì…€ë ‰í„° ì˜¤ë¥˜ ë¬´ì‹œ
            }
          }
          
          if (useAnotherButton) {
            await useAnotherButton.click();
            await page.waitForTimeout(2000);
            
            // ì´ë©”ì¼ í•„ë“œ í™•ì¸
            const hasEmailField = await page.$('input[type="email"], input#identifierId');
            if (hasEmailField) {
              this.log('ì´ë©”ì¼ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™ ì„±ê³µ (ë°©ë²• 1)', 'success');
              await this.inputEmail(page, email);
              
              // ë¹„ë°€ë²ˆí˜¸ í˜ì´ì§€ ëŒ€ê¸°
              await page.waitForSelector('input[type="password"]', { 
                visible: true, 
                timeout: 10000 
              }).catch(() => null);
              
              return true;
            }
          }
        } catch (error) {
          this.log(`ë°©ë²• 1 ì‹¤íŒ¨: ${error.message}`, 'warning');
        }
        
        // ë°©ë²• 2: URL ì¡°ì‘
        try {
          this.log('ë°©ë²• 2: URL ì¡°ì‘ìœ¼ë¡œ ì´ë©”ì¼ ì…ë ¥ í˜ì´ì§€ ì´ë™ ì‹œë„', 'info');
          
          const identifierUrl = new URL('https://accounts.google.com/signin/v2/identifier');
          identifierUrl.searchParams.set('continue', params.get('continue') || '');
          identifierUrl.searchParams.set('service', params.get('service') || 'youtube');
          identifierUrl.searchParams.set('hl', params.get('hl') || 'ko');
          identifierUrl.searchParams.set('flowName', params.get('flowName') || 'GlifWebSignIn');
          identifierUrl.searchParams.set('flowEntry', 'ServiceLogin');
          
          await page.goto(identifierUrl.toString(), {
            waitUntil: 'networkidle2',
            timeout: 30000
          });
          
          await page.waitForTimeout(2000);
          
          // í˜ì´ì§€ê°€ ì‹¤ì œë¡œ ì´ë™í–ˆëŠ”ì§€ í™•ì¸
          const newUrl = page.url();
          if (!newUrl.includes('accountchooser')) {
            const hasEmailField = await page.$('input[type="email"], input#identifierId');
            if (hasEmailField) {
              this.log('ì´ë©”ì¼ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™ ì„±ê³µ (ë°©ë²• 2)', 'success');
              await this.inputEmail(page, email);
              
              await page.waitForSelector('input[type="password"]', { 
                visible: true, 
                timeout: 10000 
              }).catch(() => null);
              
              return true;
            }
          } else {
            this.log('URL ì¡°ì‘ í›„ì—ë„ ê³„ì • ì„ íƒ í˜ì´ì§€ì— ë¨¸ë¬¼ëŸ¬ ìˆìŒ', 'warning');
          }
        } catch (error) {
          this.log(`ë°©ë²• 2 ì‹¤íŒ¨: ${error.message}`, 'warning');
        }
        
        // ë°©ë²• 3: ê³„ì • ì§ì ‘ í´ë¦­ (CDP ì‚¬ìš©)
        try {
          this.log('ë°©ë²• 3: ê³„ì • ì§ì ‘ í´ë¦­ ì‹œë„', 'info');
          
          // ê³„ì • ìš”ì†Œ ì°¾ê¸°
          const accountElement = await page.$(`[data-identifier="${email}"]`);
          if (accountElement) {
            // ìš”ì†Œì˜ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            const box = await accountElement.boundingBox();
            if (box) {
              // í´ë¦­ ìœ„ì¹˜ ê³„ì‚° (ì¤‘ì•™)
              const x = box.x + box.width / 2;
              const y = box.y + box.height / 2;
              
              this.log(`ê³„ì • í´ë¦­ ìœ„ì¹˜: (${x}, ${y})`, 'info');
              
              // ë§ˆìš°ìŠ¤ ì´ë™ í›„ í´ë¦­
              await page.mouse.move(x, y);
              await page.waitForTimeout(500);
              await page.mouse.click(x, y);
              
              await page.waitForTimeout(3000);
              
              // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ í™•ì¸
              const hasPasswordField = await page.$('input[type="password"]');
              if (hasPasswordField) {
                this.log('ë¹„ë°€ë²ˆí˜¸ í˜ì´ì§€ë¡œ ì´ë™ ì„±ê³µ (ë°©ë²• 3)', 'success');
                return true;
              }
            }
          }
        } catch (error) {
          this.log(`ë°©ë²• 3 ì‹¤íŒ¨: ${error.message}`, 'warning');
        }
        
        // ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš°
        this.log('ëª¨ë“  ê³„ì • ì„ íƒ ìš°íšŒ ë°©ë²• ì‹¤íŒ¨', 'error');
        return false;
      } else {
        this.log(`${email} ê³„ì •ì´ ëª©ë¡ì— ì—†ìŒ - "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" í´ë¦­`, 'warning');
        
        // "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ í´ë¦­
        try {
          const useAnotherButton = await page.$('div[data-identifier=""]') || 
                                   await page.$('[aria-label*="ë‹¤ë¥¸ ê³„ì •"]') ||
                                   await page.$('[aria-label*="Use another account"]');
          
          if (useAnotherButton) {
            await useAnotherButton.click();
            await page.waitForTimeout(2000);
            
            const hasEmailField = await page.$('input[type="email"], input#identifierId');
            if (hasEmailField) {
              this.log('ì´ë©”ì¼ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™ ì„±ê³µ', 'success');
              await this.inputEmail(page, email);
              return true;
            }
          }
        } catch (error) {
          this.log(`"ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨: ${error.message}`, 'warning');
        }
        
        // ëŒ€ì²´ ë°©ë²•: URL ì¡°ì‘
        this.log('URL ì¡°ì‘ìœ¼ë¡œ ì¬ì‹œë„', 'info');
        const identifierUrl = new URL('https://accounts.google.com/signin/v2/identifier');
        identifierUrl.searchParams.set('continue', params.get('continue') || '');
        identifierUrl.searchParams.set('service', params.get('service') || 'youtube');
        identifierUrl.searchParams.set('hl', params.get('hl') || 'ko');
        identifierUrl.searchParams.set('flowName', 'GlifWebSignIn');
        identifierUrl.searchParams.set('flowEntry', 'ServiceLogin');
        
        await page.goto(identifierUrl.toString(), {
          waitUntil: 'networkidle2',
          timeout: 30000
        });
        
        await page.waitForTimeout(2000);
        
        // ì´ë©”ì¼ ì…ë ¥
        await this.inputEmail(page, email);
        return true;
      }
      
    } catch (error) {
      this.log(`ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
      return false;
    }
  }

  /**
   * ì´ë©”ì¼ ì…ë ¥
   */
  async inputEmail(page, email) {
    try {
      this.log('ì´ë©”ì¼ ì…ë ¥ ì‹œì‘', 'info');
      
      const emailInput = await page.$('input[type="email"], input#identifierId');
      if (emailInput) {
        await emailInput.click({ clickCount: 3 });
        await emailInput.type(email, { delay: 100 });
        this.log(`ì´ë©”ì¼ ì…ë ¥: ${email}`, 'success');
        
        // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter
        const nextButton = await page.$('#identifierNext');
        if (nextButton) {
          await nextButton.click();
        } else {
          await page.keyboard.press('Enter');
        }
        
        this.log('ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰', 'success');
        await page.waitForTimeout(3000);
        return true;
      }
      
      return false;
      
    } catch (error) {
      this.log(`ì´ë©”ì¼ ì…ë ¥ ì‹¤íŒ¨: ${error.message}`, 'error');
      return false;
    }
  }

  /**
   * ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
   */
  async inputPassword(page, password) {
    try {
      this.log('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œì‘', 'info');
      
      // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ëŒ€ê¸°
      await page.waitForSelector('input[type="password"]', { 
        visible: true, 
        timeout: 10000 
      }).catch(() => null);
      
      const passwordInput = await page.$('input[type="password"]');
      if (passwordInput) {
        await passwordInput.click({ clickCount: 3 });
        await passwordInput.type(password, { delay: 100 });
        this.log('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ', 'success');
        
        // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter
        const nextButton = await page.$('#passwordNext');
        if (nextButton) {
          await nextButton.click();
        } else {
          await page.keyboard.press('Enter');
        }
        
        this.log('ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...', 'info');
        await page.waitForTimeout(3000);
        return true;
      }
      
      return false;
      
    } catch (error) {
      this.log(`ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹¤íŒ¨: ${error.message}`, 'error');
      return false;
    }
  }

  /**
   * í†µí•© ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤
   */
  async performLogin(page, credentials) {
    try {
      this.log('ğŸ” ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘', 'info');
      
      // ìë™í™” ê°ì§€ ìš°íšŒ ì„¤ì •
      await page.setBypassCSP(true);
      await page.evaluateOnNewDocument(() => {
        Object.defineProperty(navigator, 'webdriver', {
          get: () => undefined
        });
      });
      
      const currentUrl = page.url();
      
      // 1. ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬
      if (currentUrl.includes('accountchooser')) {
        const handled = await this.handleAccountChooser(page, credentials.email);
        if (!handled) {
          return { success: false, reason: 'Failed to handle account chooser' };
        }
      } else if (currentUrl.includes('accounts.google.com')) {
        // 2. ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ì¸ ê²½ìš°
        const hasEmailField = await page.$('input[type="email"], input#identifierId');
        if (hasEmailField) {
          await this.inputEmail(page, credentials.email);
        }
      }
      
      // 3. ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
      const hasPasswordField = await page.$('input[type="password"]');
      if (hasPasswordField && credentials.password) {
        await this.inputPassword(page, credentials.password);
      }
      
      // 4. ë¡œê·¸ì¸ ì™„ë£Œ ëŒ€ê¸°
      await page.waitForTimeout(5000);
      
      // 5. ìµœì¢… ìƒíƒœ í™•ì¸
      const finalUrl = page.url();
      if (finalUrl.includes('youtube.com') && !finalUrl.includes('accounts.google.com')) {
        this.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        
        // YouTube Premium í˜ì´ì§€ë¡œ ì´ë™ (í•„ìš”í•œ ê²½ìš°)
        if (!finalUrl.includes('paid_memberships')) {
          await page.goto('https://www.youtube.com/paid_memberships', {
            waitUntil: 'networkidle2',
            timeout: 30000
          });
        }
        
        return { success: true };
      }
      
      // 6. íŒ¨ìŠ¤í‚¤ ê±´ë„ˆë›°ê¸° ì²˜ë¦¬
      if (finalUrl.includes('passkeys') || finalUrl.includes('passwordless')) {
        this.log('íŒ¨ìŠ¤í‚¤ ë“±ë¡ ê±´ë„ˆë›°ê¸°', 'warning');
        const skipButton = await page.$('button:has-text("ë‚˜ì¤‘ì—"), button:has-text("Skip"), button:has-text("Not now")');
        if (skipButton) {
          await skipButton.click();
          await page.waitForTimeout(3000);
          return { success: true };
        }
      }
      
      // 7. 2ë‹¨ê³„ ì¸ì¦ í™•ì¸
      const has2FA = await page.evaluate(() => {
        const text = document.body?.innerText || '';
        return text.includes('2-Step Verification') || 
               text.includes('2ë‹¨ê³„ ì¸ì¦') ||
               text.includes('í™•ì¸ ì½”ë“œ');
      });
      
      if (has2FA) {
        this.log('2ë‹¨ê³„ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
        return { success: false, reason: '2FA required' };
      }
      
      return { success: false, reason: 'Login incomplete' };
      
    } catch (error) {
      this.log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      return { success: false, reason: error.message };
    }
  }
}

module.exports = WorkingAuthenticationService;