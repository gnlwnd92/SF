/**
 * Enhanced Resume Subscription Use Case
 * ë‹¤êµ­ì–´ ì§€ì› ë° ê°œì„ ëœ ê²°ì œ ì¬ê°œ ì›Œí¬í”Œë¡œìš°
 */

const chalk = require('chalk');
const fs = require('fs').promises;
const path = require('path');
const GoogleLoginHelper = require('../../infrastructure/adapters/GoogleLoginHelperUltimate');
const ImprovedAuthenticationService = require('../../services/ImprovedAuthenticationService');
const WorkingAuthenticationService = require('../../services/WorkingAuthenticationService');
const { languages, detectLanguage, parseDate } = require('../../infrastructure/config/multilanguage');
const PageStateAnalyzer = require('../../services/PageStateAnalyzer');
const NavigationStrategy = require('../../services/NavigationStrategy');

class EnhancedResumeSubscriptionUseCase {
  constructor({
    adsPowerAdapter,
    youtubeAdapter,
    profileRepository,
    pauseSheetRepository,
    logger,
    config = {}
  }) {
    this.adsPowerAdapter = adsPowerAdapter;
    this.youtubeAdapter = youtubeAdapter;
    this.profileRepository = profileRepository;
    this.pauseSheetRepository = pauseSheetRepository;
    this.logger = logger || console;
    this.currentLanguage = 'en';
    this.resumeInfo = {};
    this.savedNextBillingDate = null; // ì´ì „ì— ì €ì¥í•œ ë‚ ì§œ (ì¼ì‹œì¤‘ì§€ì™€ ë™ì¼í•˜ê²Œ)
    this.config = config; // ì„¤ì • ì €ì¥
    
    // ì‘ë™í•˜ëŠ” ì¸ì¦ ì„œë¹„ìŠ¤ ì´ˆê¸°í™” - URL ì¡°ì‘ ë°©ì‹
    this.authService = new WorkingAuthenticationService({
      debugMode: true,
      maxRetries: 3
    });
    
    // í˜ì´ì§€ ìƒíƒœ ë¶„ì„ê¸° ë° ë„¤ë¹„ê²Œì´ì…˜ ì „ëµ ì´ˆê¸°í™”
    this.pageAnalyzer = new PageStateAnalyzer(logger);
    this.navigationStrategy = new NavigationStrategy(logger);
  }

  /**
   * ê²°ì œ ì¬ê°œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
   */
  async execute(profileId, options = {}) {
    const startTime = Date.now();
    
    // í”„ë¡œí•„ ë°ì´í„° ì €ì¥ (ë¡œê·¸ì¸ìš©)
    this.profileData = options.profileData || {};
    this.debugMode = options.debugMode || false;
    
    const result = {
      profileId,
      success: false,
      status: null,
      resumeDate: null,
      nextBillingDate: null,
      browserIP: null,
      error: null,
      duration: 0
    };

    try {
      this.log(`í”„ë¡œí•„ ${profileId} ê²°ì œ ì¬ê°œ ì‹œì‘`, 'info');

      // 1. ë¸Œë¼ìš°ì € ì—°ê²°
      const browser = await this.connectBrowser(profileId);
      if (!browser) {
        throw new Error('ë¸Œë¼ìš°ì € ì—°ê²° ì‹¤íŒ¨');
      }

      // 2. YouTube Premium í˜ì´ì§€ ì´ë™
      await this.navigateToPremiumPage(browser);

      // 3. ì–¸ì–´ ê°ì§€
      this.currentLanguage = await this.detectPageLanguage(browser);
      this.log(`ê°ì§€ëœ ì–¸ì–´: ${languages[this.currentLanguage].name}`, 'info');

      // 4. í˜„ì¬ ìƒíƒœ í™•ì¸
      const currentStatus = await this.checkCurrentStatus(browser);
      
      // ì´ë¯¸ í™œì„± ìƒíƒœì¸ ê²½ìš°
      if (currentStatus.isActive) {
        this.log('ì´ë¯¸ í™œì„± ìƒíƒœì…ë‹ˆë‹¤', 'warning');
        result.status = 'already_active';
        result.success = true;
        
        // ë‚ ì§œ ì •ë³´ ì¶”ì¶œ
        if (currentStatus.nextBillingDate) {
          result.nextBillingDate = parseDate(currentStatus.nextBillingDate, this.currentLanguage);
        }
      } else {
        // checkCurrentStatusì—ì„œ ì–»ì€ ë‚ ì§œ ì €ì¥ (ì¬ê°œ ì „)
        this.savedNextBillingDate = currentStatus.nextBillingDate;
        
        if (!currentStatus.hasResumeButton) {
          this.log('Resume ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - ê³„ì •ì´ í™œì„± ìƒíƒœì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'warning');
          result.status = 'no_resume_option';
          result.success = false;
          result.error = 'Resume ì˜µì…˜ì´ ì—†ìŒ';
        } else {
          // 5. ì¬ê°œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
          const resumeResult = await this.executeResumeWorkflow(browser);
          
          if (resumeResult.success) {
            result.success = true;
            result.status = 'resumed';
            result.resumeDate = resumeResult.resumeDate;
            result.nextBillingDate = resumeResult.nextBillingDate;
            
            // íŒì—…ì—ì„œ ë‚ ì§œë¥¼ ëª» ì°¾ì•˜ì§€ë§Œ ì´ì „ì— ì €ì¥í•œ ë‚ ì§œê°€ ìˆëŠ” ê²½ìš°
            if (!result.nextBillingDate && this.savedNextBillingDate) {
              this.log('íŒì—…ì—ì„œ ë‚ ì§œë¥¼ ì°¾ì§€ ëª»í•¨, ì´ì „ì— ì €ì¥í•œ ë‚ ì§œ ì‚¬ìš©', 'warning');
              result.nextBillingDate = this.savedNextBillingDate;
              this.log(`ì €ì¥ëœ ë‚ ì§œ ì‚¬ìš©: ${result.nextBillingDate}`, 'info');
            }
            
            this.log('ê²°ì œ ì¬ê°œ ì„±ê³µ', 'success');
          } else {
            throw new Error(resumeResult.error || 'ê²°ì œ ì¬ê°œ ì‹¤íŒ¨');
          }
        }
      }

      // 6. IP í™•ì¸ (ì‹ ê·œ ì¶”ê°€)
      result.browserIP = await this.checkBrowserIP();
      
      // 7. Google Sheets ì—…ë°ì´íŠ¸ (IP ì •ë³´ í¬í•¨)
      if (this.pauseSheetRepository) {
        await this.updateGoogleSheets(profileId, result);
      }

      // 8. ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ (ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ ì „ì— ì‹¤í–‰)
      await this.captureScreenshot(profileId, result);
      
      // 9. ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ
      await this.disconnectBrowser(profileId);

    } catch (error) {
      this.log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      result.error = error.message;
      
      // reCAPTCHA ê°ì§€ëœ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
      if (error.message === 'RECAPTCHA_DETECTED') {
        result.status = 'recaptcha_required';
        result.error = 'ë²ˆí˜¸ì¸ì¦ê³„ì •';
        result.success = false;
      } else {
        result.status = 'error';
      }
      
      // ìŠ¤í¬ë¦°ìƒ· ì‹œë„ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„, ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ ì „ì—)
      try {
        await this.captureScreenshot(profileId, result);
      } catch (e) {
        this.log(`ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì‹¤íŒ¨: ${e.message}`, 'warning');
      }
      
      // ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ ì‹œë„
      try {
        await this.disconnectBrowser(profileId);
      } catch (e) {
        // ë¬´ì‹œ
      }
    }

    result.duration = Math.round((Date.now() - startTime) / 1000);
    this.log(`ì²˜ë¦¬ ì‹œê°„: ${result.duration}ì´ˆ`, 'info');

    return result;
  }

  /**
   * ë¸Œë¼ìš°ì € ì—°ê²°
   */
  async connectBrowser(profileId) {
    try {
      // AdsPower ë¸Œë¼ìš°ì € ì‹¤í–‰
      const session = await this.adsPowerAdapter.launchBrowser(profileId);
      
      if (!session || !session.browser) {
        throw new Error('ë¸Œë¼ìš°ì € ì„¸ì…˜ íšë“ ì‹¤íŒ¨');
      }

      // í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
      const page = await this.adsPowerAdapter.getPage(profileId);
      if (!page) {
        throw new Error('ë¸Œë¼ìš°ì € í˜ì´ì§€ íšë“ ì‹¤íŒ¨');
      }

      this.browser = session.browser;
      this.page = page;
      
      // BrowserController ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ë¡œê·¸ì¸ì— í•„ìš”)
      const BrowserController = require('../../infrastructure/adapters/BrowserController');
      this.controller = new BrowserController(page, {
        debugMode: this.debugMode,
        humanMode: true
      });
      
      return { browser: session.browser, page };
    } catch (error) {
      this.log(`ë¸Œë¼ìš°ì € ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
      return null;
    }
  }

  /**
   * YouTube Premium í˜ì´ì§€ë¡œ ì´ë™ (ë¡œê·¸ì¸ ì²˜ë¦¬ í¬í•¨)
   */
  async navigateToPremiumPage(browser) {
    let retryCount = 0;
    const maxRetries = 3;
    let pageLoaded = false;
    
    while (retryCount < maxRetries) {
      try {
        console.log(chalk.cyan(`ğŸ“„ [Navigation] YouTube Premium í˜ì´ì§€ë¡œ ì´ë™ (ì‹œë„ ${retryCount + 1}/${maxRetries})`));
        
        // í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ë¶„ì„
        const currentState = await this.pageAnalyzer.analyzePageState(this.page);
        console.log(chalk.cyan(`ğŸ“„ [PageState] í˜„ì¬ ìƒíƒœ: ${currentState.pageType}, ë¡œê·¸ì¸: ${currentState.loginStatus.isLoggedIn ? 'âœ…' : 'âŒ'}`));
        
        // ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ìš°
        if (!currentState.loginStatus.isLoggedIn) {
          console.log(chalk.yellow(`ğŸ” [Login] ë¡œê·¸ì¸ í•„ìš” ê°ì§€`));
          await this.handleLoginIfNeeded(currentState);
          // ë¡œê·¸ì¸ í›„ ìƒíƒœ ì¬í™•ì¸
          const afterLoginState = await this.pageAnalyzer.analyzePageState(this.page);
          if (!afterLoginState.loginStatus.isLoggedIn) {
            throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
          }
        }
        
        // YouTube Premium í˜ì´ì§€ë¡œ ë„¤ë¹„ê²Œì´ì…˜ ê³„íš ìˆ˜ë¦½
        const navPlan = await this.navigationStrategy.planNavigation(currentState, 'youtube_premium');
        
        // ë„¤ë¹„ê²Œì´ì…˜ ì‹¤í–‰
        for (const step of navPlan.steps) {
          const result = await this.navigationStrategy.executeStep(this.page, step);
          if (result.needsLogin) {
            await this.handleLoginIfNeeded(result.loginDetails);
          } else if (result.completed) {
            console.log(chalk.green(`âœ… [Navigation] ì™„ë£Œ: ${result.reason}`));
            break;
          }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸° ë° ìµœì¢… ìƒíƒœ í™•ì¸
        const finalState = await this.pageAnalyzer.waitForPageReady(this.page, {
          targetPage: 'premium',
          timeout: 15000
        });
        
        this.log(`ìµœì¢… í˜ì´ì§€ íƒ€ì…: ${finalState.pageType}`, 'debug');
        
        // YouTube Premium í˜ì´ì§€ í™•ì¸
        if (finalState.pageType.includes('youtube_premium')) {
          this.log('YouTube Premium í˜ì´ì§€ í™•ì¸ë¨', 'success');
          pageLoaded = true;
          break;
        } else if (finalState.pageContent.hasError) {
          this.log('ì˜¤ë¥˜ ê°ì§€', 'error');
          throw new Error('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨');
        } else {
          this.log(`í˜„ì¬ í˜ì´ì§€ íƒ€ì…: ${finalState.pageType}`, 'warning');
        }
        
      } catch (error) {
        retryCount++;
        this.log(`í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨ (ì‹œë„ ${retryCount}/${maxRetries}): ${error.message}`, 'warning');
        
        if (retryCount < maxRetries) {
          // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
          if (error.message.includes('ERR_FAILED') || 
              error.message.includes('ERR_CONNECTION') ||
              error.message.includes('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜')) {
            
            this.log('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê°ì§€, ë¸Œë¼ìš°ì € ìºì‹œ ì •ë¦¬ ë° ì¬ì‹œë„', 'warning');
            
            // ë¸Œë¼ìš°ì € ìºì‹œ ì •ë¦¬ ì‹œë„
            try {
              await this.page.evaluate(() => {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
                localStorage.clear();
                sessionStorage.clear();
              });
            } catch (e) {
              // ë¬´ì‹œ
            }
            
            // ëŒ€ê¸° ì‹œê°„ì„ ì ì§„ì ìœ¼ë¡œ ì¦ê°€
            const waitTime = 3000 * retryCount;
            this.log(`${waitTime/1000}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„`, 'info');
            await new Promise(resolve => setTimeout(resolve, waitTime));
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œë„
            try {
              await this.page.reload({ waitUntil: 'domcontentloaded', timeout: 30000 });
            } catch (reloadError) {
              this.log('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨, YouTube í™ˆí˜ì´ì§€ ê²½ìœ  ì‹œë„', 'warning');
              // YouTube í™ˆí˜ì´ì§€ë¥¼ ê±°ì³ì„œ ì´ë™
              try {
                await this.page.goto('https://www.youtube.com', {
                  waitUntil: 'domcontentloaded',
                  timeout: 20000
                });
                await new Promise(resolve => setTimeout(resolve, 2000));
              } catch (homeError) {
                // ë¬´ì‹œí•˜ê³  ì§ì ‘ ì´ë™ ì‹œë„
              }
            }
          }
        } else {
          this.log('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼, í˜„ì¬ í˜ì´ì§€ì—ì„œ ê³„ì† ì§„í–‰', 'warning');
          
          // í˜„ì¬ í˜ì´ì§€ê°€ YouTubeì¸ì§€ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸
          const currentUrl = this.page.url();
          if (currentUrl.includes('youtube.com')) {
            this.log('í˜„ì¬ í˜ì´ì§€ê°€ YouTubeì´ë¯€ë¡œ ê³„ì† ì§„í–‰', 'info');
          } else {
            this.log('YouTubeê°€ ì•„ë‹Œ í˜ì´ì§€ì—ì„œ ì§„í–‰ - ê²°ê³¼ê°€ ë¶ˆí™•ì‹¤í•  ìˆ˜ ìˆìŒ', 'warning');
          }
        }
      }
    }
  }
  
  /**
   * ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ìš° ì²˜ë¦¬ (Minimal ëª¨ë“œ í†µí•©)
   */
  async handleLoginIfNeeded(loginDetails = null) {
    try {
      this.log('ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
      
      // ë¡œê·¸ì¸ ëª¨ë“œ í™•ì¸
      const loginMode = this.config?.loginMode || process.env.LOGIN_MODE || 'minimal';
      const useMacroMode = loginMode === 'macro';
      const useMinimalMode = loginMode === 'minimal';
      
      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      let isLoggedIn = false;
      let needsLogin = false;
      
      if (useMacroMode) {
        // Macro ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ì²´í¬
        const GoogleLoginHelperMacro = require('../../infrastructure/adapters/GoogleLoginHelperMacro');
        const macroHelper = new GoogleLoginHelperMacro(this.page, { debugMode: this.config?.debugMode });
        isLoggedIn = await macroHelper.checkLoginStatus();
        needsLogin = !isLoggedIn;
      } else if (useMinimalMode) {
        // Minimal ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ì²´í¬
        const GoogleLoginHelperMinimal = require('../../infrastructure/adapters/GoogleLoginHelperMinimal');
        const minimalHelper = new GoogleLoginHelperMinimal(this.page, null, { debugMode: this.config?.debugMode });
        isLoggedIn = await minimalHelper.checkLoginStatus();
        needsLogin = !isLoggedIn;
      } else {
        // ê¸°ì¡´ ë°©ì‹
        isLoggedIn = await this.authService.checkLoginStatus(this.page);
        needsLogin = loginDetails ? !loginDetails.isLoggedIn : !isLoggedIn;
      }
      
      if (needsLogin) {
        const modeName = useMacroMode ? 'Macro' : (useMinimalMode ? 'Minimal' : 'ê¸°ì¡´');
        this.log(`ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ${modeName} ëª¨ë“œë¡œ ë¡œê·¸ì¸ ì‹œì‘...`, 'warning');
        
        // loginDetailsì—ì„œ ë¡œê·¸ì¸ ë‹¨ê³„ ì •ë³´ í™œìš©
        if (loginDetails && loginDetails.needsAction) {
          this.log(`í˜„ì¬ ë¡œê·¸ì¸ ë‹¨ê³„: ${loginDetails.stage}, í•„ìš”í•œ ì‘ì—…: ${loginDetails.needsAction}`, 'info');
        }
        
        // Google Sheetsì—ì„œ ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ ë§¤í•‘)
        const accountInfo = {
          email: this.profileData?.email || this.profileData?.googleId,
          password: this.profileData?.password,       // Bì—´
          recoveryEmail: this.profileData?.recoveryEmail, // Cì—´  
          totpSecret: this.profileData?.code || this.profileData?.totpSecret // Dì—´
        };
        
        this.log(`ğŸ“§ ë¡œê·¸ì¸ ê³„ì •: ${accountInfo.email}`, 'info');
        
        if (!accountInfo.email || !accountInfo.password) {
          this.log('âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
          throw new Error('ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ');
        }
        
        // TOTP ì‹œí¬ë¦¿ í‚¤ í™•ì¸
        if (accountInfo.totpSecret) {
          this.log(`âœ… TOTP ì‹œí¬ë¦¿ í‚¤ ì¡´ì¬`, 'success');
        } else {
          this.log(`âš ï¸ TOTP ì‹œí¬ë¦¿ í‚¤ ì—†ìŒ`, 'warning');
        }
        
        // í˜„ì¬ í˜ì´ì§€ ìƒíƒœ í™•ì¸
        const currentUrl = this.page.url();
        this.log(`ğŸ“ ë¡œê·¸ì¸ ì‹œì‘ URL: ${currentUrl}`, 'info');
        
        let loginResult;
        
        if (useMacroMode) {
          // Macro ëª¨ë“œ ë¡œê·¸ì¸
          this.log('ğŸ–±ï¸ Macro ëª¨ë“œ ë¡œê·¸ì¸ ì‹œì‘ (ì¸ê°„ì²˜ëŸ¼ ë§ˆìš°ìŠ¤ ì›€ì§ì„)...', 'info');
          const GoogleLoginHelperMacro = require('../../infrastructure/adapters/GoogleLoginHelperMacro');
          const macroHelper = new GoogleLoginHelperMacro(this.page, { 
            debugMode: this.config?.debugMode,
            screenshotEnabled: true,
            mouseSpeed: 'normal',
            typingSpeed: 'normal'
          });
          
          loginResult = await macroHelper.login({
            email: accountInfo.email,
            password: accountInfo.password,
            totpSecret: accountInfo.totpSecret
          });
          
          // booleanì„ ê°ì²´ë¡œ ë³€í™˜
          loginResult = { success: loginResult === true };
          
        } else if (useMinimalMode) {
          // Minimal ëª¨ë“œ ë¡œê·¸ì¸
          this.log('ğŸš€ Minimal ëª¨ë“œ ë¡œê·¸ì¸ ì‹œì‘ (ë¸Œë¼ìš°ì € í™˜ê²½ ë¬´ìˆ˜ì •)...', 'info');
          const GoogleLoginHelperMinimal = require('../../infrastructure/adapters/GoogleLoginHelperMinimal');
          const minimalHelper = new GoogleLoginHelperMinimal(this.page, null, { 
            debugMode: this.config?.debugMode,
            screenshotEnabled: true 
          });
          
          loginResult = await minimalHelper.login({
            email: accountInfo.email,
            password: accountInfo.password,
            totpSecret: accountInfo.totpSecret
          });
          
          // booleanì„ ê°ì²´ë¡œ ë³€í™˜
          loginResult = { success: loginResult === true };
          
        } else {
          // ê¸°ì¡´ ë°©ì‹ ë¡œê·¸ì¸
          this.log('ğŸš€ ê¸°ì¡´ ë°©ì‹ ë¡œê·¸ì¸ ì‹œì‘...', 'info');
          loginResult = await this.authService.performLogin(this.page, {
            email: accountInfo.email,
            password: accountInfo.password,
            totpSecret: accountInfo.totpSecret
          });
        }
        
        if (loginResult.success) {
          const modeName = useMacroMode ? 'Macro' : (useMinimalMode ? 'Minimal' : 'ê¸°ì¡´');
          this.log(`âœ… ìë™ ë¡œê·¸ì¸ ì„±ê³µ (${modeName} ëª¨ë“œ)`, 'success');
          
          // ë¡œê·¸ì¸ í›„ URL í™•ì¸
          const afterLoginUrl = this.page.url();
          this.log(`ğŸ“ ë¡œê·¸ì¸ í›„ URL: ${afterLoginUrl}`, 'info');
          
          // YouTube Premium í˜ì´ì§€ë¡œ ë‹¤ì‹œ ì´ë™
          this.log('ğŸ¯ YouTube Premium í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...', 'info');
          await this.page.goto('https://www.youtube.com/paid_memberships', {
            waitUntil: 'domcontentloaded',
            timeout: 15000
          });
          await this.page.waitForTimeout(3000);
          
          // í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í™•ì¸
          const finalUrl = this.page.url();
          this.log(`ğŸ“ ìµœì¢… í˜ì´ì§€ URL: ${finalUrl}`, 'info');
          
        } else {
          this.log(`âŒ ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${loginResult.reason}`, 'error');
          
          // ì‹¤íŒ¨ ì´ìœ ë³„ ì²˜ë¦¬
          if (loginResult.reason === 'RECAPTCHA_DETECTED') {
            this.log('ğŸ›¡ï¸ reCAPTCHA ê°ì§€ - ë²ˆí˜¸ì¸ì¦ê³„ì •ìœ¼ë¡œ í‘œì‹œ', 'warning');
            throw new Error('RECAPTCHA_DETECTED');
          } else if (loginResult.reason === 'TOTP secret missing') {
            this.log('âš ï¸ TOTP ì‹œí¬ë¦¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. 2ë‹¨ê³„ ì¸ì¦ ì„¤ì • í™•ì¸ í•„ìš”', 'warning');
          } else if (loginResult.reason === 'Wrong password') {
            this.log('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° í™•ì¸ í•„ìš”', 'error');
          }
          
          // ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ë””ë²„ê¹… ì •ë³´
          const debugInfo = await this.page.evaluate(() => {
            return {
              url: window.location.href,
              title: document.title,
              hasPasswordField: document.querySelector('input[type="password"]') !== null,
              hasAccountChooser: document.querySelector('[data-identifier]') !== null,
              pageText: document.body.innerText.substring(0, 300)
            };
          });
          
          this.log(`ğŸ” ë¡œê·¸ì¸ ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´:`, 'error');
          this.log(`   URL: ${debugInfo.url}`, 'error');
          this.log(`   ì œëª©: ${debugInfo.title}`, 'error');
          this.log(`   ë¹„ë°€ë²ˆí˜¸ í•„ë“œ: ${debugInfo.hasPasswordField ? 'ìˆìŒ' : 'ì—†ìŒ'}`, 'error');
          this.log(`   ê³„ì • ì„ íƒ í˜ì´ì§€: ${debugInfo.hasAccountChooser ? 'ìˆìŒ' : 'ì—†ìŒ'}`, 'error');
          this.log(`   í˜ì´ì§€ ë‚´ìš©: ${debugInfo.pageText}...`, 'error');
          
          throw new Error('ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨');
        }
      } else {
        this.log('âœ… ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info');
      }
    } catch (error) {
      this.log(`ğŸ’¥ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ í˜„ì¬ í˜ì´ì§€ ìŠ¤í¬ë¦°ìƒ· ì €ì¥
      try {
        const timestamp = Date.now();
        const screenshotPath = `screenshots/login_error_${timestamp}.png`;
        await this.page.screenshot({ path: screenshotPath });
        this.log(`ğŸ“¸ ì˜¤ë¥˜ ìŠ¤í¬ë¦°ìƒ· ì €ì¥: ${screenshotPath}`, 'warning');
      } catch (e) {
        this.log('ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì‹¤íŒ¨', 'warning');
      }
      
      throw error;
    }
  }

  /**
   * í˜ì´ì§€ ì–¸ì–´ ê°ì§€
   */
  async detectPageLanguage(browser) {
    const pageText = await this.page.evaluate(() => document.body?.textContent || '');
    return detectLanguage(pageText);
  }

  /**
   * í˜„ì¬ ìƒíƒœ í™•ì¸ (ê°œì„ ëœ ë²„íŠ¼ í™•ì¸ ë°©ì‹)
   */
  async checkCurrentStatus(browser) {
    const lang = languages[this.currentLanguage];
    
    // ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œë„
    await this.clickManageButton();
    
    // ìƒíƒœ í™•ì¸ - ê°œì„ ëœ ë²„íŠ¼ í™•ì¸ ë¡œì§
    const status = await this.page.evaluate((langData) => {
      const pageText = document.body?.textContent || '';
      const result = {
        isActive: false,
        isPaused: false,
        hasResumeButton: false,
        hasPauseButton: false,
        nextBillingDate: null
      };

      // ëª¨ë“  ë²„íŠ¼ ê²€ì‚¬ - ë” ì •í™•í•œ ì„ íƒì ì‚¬ìš©
      const buttons = document.querySelectorAll('button, [role="button"], yt-button-renderer, tp-yt-paper-button');
      
      for (const btn of buttons) {
        const btnText = btn.textContent?.trim();
        if (!btnText) continue;
        
        // Resume ë²„íŠ¼ í™•ì¸ - ë‹¤ì–‘í•œ ë³€í˜• ì²´í¬
        const resumeFound = langData.buttons.resume.some(resumeText => {
          return btnText === resumeText || 
                 btnText.includes(resumeText) ||
                 btnText.toLowerCase().includes(resumeText.toLowerCase());
        });
        
        if (resumeFound && btn.offsetHeight > 0) {
          result.hasResumeButton = true;
          result.isPaused = true;
          
          // Resume ë²„íŠ¼ì´ ìˆëŠ” ì˜ì—­ì—ì„œ ë‚ ì§œ ì°¾ê¸°
          const parentElement = btn.closest('div') || btn.parentElement;
          if (parentElement) {
            const parentText = parentElement.textContent || '';
            const datePattern = /(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2}|\d{4}[\.\/-]\s*\d{1,2}[\.\/-]\s*\d{1,2}|\d{1,2}[\.\/-]\s*\d{1,2}[\.\/-]\s*\d{4}/i;
            const dateMatch = parentText.match(datePattern);
            if (dateMatch) {
              result.nextBillingDate = dateMatch[0];
            }
          }
        }
        
        // Pause ë²„íŠ¼ í™•ì¸
        const pauseFound = langData.buttons.pause.some(pauseText => {
          return btnText === pauseText || 
                 btnText.includes(pauseText) ||
                 btnText.toLowerCase().includes(pauseText.toLowerCase());
        });
        
        if (pauseFound && btn.offsetHeight > 0) {
          result.hasPauseButton = true;
          result.isActive = true;
        }
      }
      
      // ë©”ë‰´ ì•„ì´í…œë„ í™•ì¸
      const menuItems = document.querySelectorAll('[role="menuitem"], ytd-menu-navigation-item-renderer, tp-yt-paper-item');
      for (const item of menuItems) {
        const itemText = item.textContent?.trim();
        if (!itemText) continue;
        
        // Resume ì˜µì…˜ í™•ì¸
        if (langData.buttons.resume.some(resumeText => itemText.includes(resumeText))) {
          result.hasResumeButton = true;
          result.isPaused = true;
        }
        
        // Pause ì˜µì…˜ í™•ì¸
        if (langData.buttons.pause.some(pauseText => itemText.includes(pauseText))) {
          result.hasPauseButton = true;
          result.isActive = true;
        }
      }

      // ë‚ ì§œ ì •ë³´ ì¶”ì¶œ (ì „ì²´ í˜ì´ì§€ì—ì„œ)
      if (!result.nextBillingDate) {
        const datePattern = /(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s*\d{4}|\d{4}[\.\/-]\s*\d{1,2}[\.\/-]\s*\d{1,2}|\d{1,2}[\.\/-]\s*\d{1,2}[\.\/-]\s*\d{4}/gi;
        const dateMatches = pageText.match(datePattern);
        if (dateMatches && dateMatches.length > 0) {
          result.nextBillingDate = dateMatches[0];
        }
      }

      return result;
    }, lang);

    this.log(`ìƒíƒœ í™•ì¸ - í™œì„±: ${status.isActive}, ì¼ì‹œì¤‘ì§€: ${status.isPaused}, Resume ë²„íŠ¼: ${status.hasResumeButton}`, 'info');
    
    return status;
  }

  /**
   * ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­
   */
  async clickManageButton() {
    const lang = languages[this.currentLanguage];
    
    const clicked = await this.page.evaluate((manageTexts) => {
      const buttons = Array.from(document.querySelectorAll('button, [role="button"], yt-button-renderer'));
      
      for (const text of manageTexts) {
        const button = buttons.find(btn => {
          const btnText = btn.textContent?.trim();
          return btnText && (btnText === text || btnText.includes(text));
        });
        
        if (button && button.offsetHeight > 0) {
          button.scrollIntoView({ behavior: 'smooth', block: 'center' });
          button.click();
          return true;
        }
      }
      return false;
    }, lang.buttons.manageMemership);
    
    if (clicked) {
      // í´ë¦­ í›„ í˜ì´ì§€ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ (ì¼ì‹œì¤‘ì§€ì™€ ë™ì¼í•˜ê²Œ 5ì´ˆ)
      await new Promise(resolve => setTimeout(resolve, 5000));
      return true;
    }
    
    return false;
  }

  /**
   * ê²°ì œ ì¬ê°œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (ì™„ì „í•œ ì›Œí¬í”Œë¡œìš° í†µí•©)
   */
  async executeResumeWorkflow(browser) {
    const result = {
      success: false,
      resumeDate: null,
      nextBillingDate: null,
      error: null
    };

    try {
      // 1. í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì¬í™•ì¸
      this.log('í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì¬í™•ì¸ ì¤‘...', 'info');
      const currentUrl = this.page.url();
      if (!currentUrl.includes('paid_memberships')) {
        await this.page.goto('https://www.youtube.com/paid_memberships', {
          waitUntil: 'domcontentloaded',
          timeout: 15000
        });
        await this.page.waitForTimeout(3000);
      }

      // 2. ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ (í™•ì‹¤í•˜ê²Œ)
      this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ ì¬í´ë¦­ ì¤‘...', 'info');
      const manageClicked = await this.clickManageButton();
      if (!manageClicked) {
        this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨, ì§ì ‘ Resume ë²„íŠ¼ ì°¾ê¸° ì‹œë„', 'warning');
      }

      // 3. Resume ë²„íŠ¼ í´ë¦­
      this.log('Resume ë²„íŠ¼ í´ë¦­ ì‹œë„...', 'info');
      const resumeClicked = await this.clickResumeButton();
      if (!resumeClicked) {
        throw new Error('Resume ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }

      // 4. íŒì—… í™•ì¸ ë° ì²˜ë¦¬ (í–¥ìƒëœ ë²„ì „)
      this.log('íŒì—… í™•ì¸ ë° ì²˜ë¦¬ ì¤‘...', 'info');
      const popupResult = await this.confirmResumeInPopup();
      
      if (!popupResult.confirmed) {
        // íŒì—…ì´ ì—†ëŠ” ê²½ìš° í˜ì´ì§€ ë³€í™” í™•ì¸
        this.log('íŒì—…ì´ ì—†ìŒ, í˜ì´ì§€ ë³€í™” í™•ì¸ ì¤‘...', 'warning');
        await this.page.waitForTimeout(3000);
        
        const pageChanged = await this.page.evaluate(() => {
          const bodyText = document.body?.textContent || '';
          return bodyText.includes('Pause') || bodyText.includes('ì¼ì‹œì¤‘ì§€') ||
                 bodyText.includes('Next billing') || bodyText.includes('ë‹¤ìŒ ê²°ì œ');
        });
        
        if (pageChanged) {
          this.log('í˜ì´ì§€ ë³€í™” ê°ì§€ - íŒì—… ì—†ì´ ì²˜ë¦¬ë¨', 'success');
          result.confirmed = true;
        } else {
          this.log('í˜ì´ì§€ ë³€í™”ê°€ ê°ì§€ë˜ì§€ ì•ŠìŒ', 'warning');
        }
      } else {
        result.resumeDate = popupResult.resumeDate;
        result.nextBillingDate = popupResult.nextBillingDate;
        
        // íŒì—… í´ë¦­ í›„ ì²˜ë¦¬ ì™„ë£Œ ëŒ€ê¸° (ì¤‘ìš”)
        this.log('íŒì—… ì²˜ë¦¬ ì™„ë£Œ, ì„œë²„ ì‘ë‹µ ëŒ€ê¸° ì¤‘...', 'info');
        await this.page.waitForTimeout(5000);
      }

      // 5. ìµœì¢… ìƒíƒœ í™•ì¸ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í¬í•¨)
      this.log('ìµœì¢… ìƒíƒœ ê²€ì¦ ì‹œì‘...', 'info');
      const finalStatus = await this.verifyResumeSuccess();
      
      if (finalStatus.success) {
        result.success = true;
        this.log('êµ¬ë… ì¬ê°œ ì„±ê³µ í™•ì¸!', 'success');
        
        // ë‚ ì§œ ì •ë³´ ì—…ë°ì´íŠ¸
        if (finalStatus.nextBillingDate && !result.nextBillingDate) {
          result.nextBillingDate = finalStatus.nextBillingDate;
        }
      } else {
        // ì‹¤íŒ¨ ì‹œì—ë„ ìƒì„¸ ì •ë³´ ë¡œê¹…
        this.log(`ì¬ê°œ ê²€ì¦ ì‹¤íŒ¨ - Resume: ${finalStatus.hasResumeButton}, Pause: ${finalStatus.hasPauseButton}`, 'error');
        throw new Error('ì¬ê°œ ê²€ì¦ ì‹¤íŒ¨');
      }

    } catch (error) {
      this.log(`ì¬ê°œ ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜: ${error.message}`, 'error');
      result.error = error.message;
    }

    return result;
  }

  /**
   * Resume ë²„íŠ¼ í´ë¦­ (ì¼ì‹œì¤‘ì§€ ì›Œí¬í”Œë¡œìš° ì°¸ì¡° ê°œì„ )
   * ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ í›„ í˜ì´ì§€ ë‚´ìš© ë³€ê²½ì„ ì²˜ë¦¬
   */
  async clickResumeButton() {
    const lang = languages[this.currentLanguage];
    
    this.log('ì¬ê°œ ë²„íŠ¼ íƒìƒ‰ ì‹œì‘', 'info');
    this.log(`ë©¤ë²„ì‹­ ê´€ë¦¬ í˜ì´ì§€ ì—´ë¦¼ ìƒíƒœ: ${this.managementPageOpened || false}`, 'debug');
    
    // ë¨¼ì € "ë©¤ë²„ì‹­ ê´€ë¦¬" ë²„íŠ¼ ì°¾ê¸° ë° í´ë¦­
    const manageButtonSelectors = [
      'button:has-text("ë©¤ë²„ì‹­ ê´€ë¦¬")',
      'button:has-text("Manage membership")',
      '[aria-label*="ë©¤ë²„ì‹­ ê´€ë¦¬"]',
      '[aria-label*="Manage membership"]',
      'ytd-button-renderer button'
    ];
    
    let manageButtonClicked = false;
    
    for (const selector of manageButtonSelectors) {
      try {
        const manageButton = await this.page.$(selector);
        if (manageButton) {
          const buttonText = await manageButton.evaluate(el => el.textContent || el.innerText);
          if (buttonText && (buttonText.includes('ë©¤ë²„ì‹­ ê´€ë¦¬') || buttonText.includes('Manage membership'))) {
            this.log(`ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ ë°œê²¬: "${buttonText}"`, 'info');
            await manageButton.click();
            manageButtonClicked = true;
            this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ ì„±ê³µ', 'success');
            break;
          }
        }
      } catch (e) {
        // ê³„ì† ì‹œë„
      }
    }
    
    if (!manageButtonClicked) {
      // CSS ì„ íƒìë¡œ ëª» ì°¾ìœ¼ë©´ evaluateë¡œ ì§ì ‘ ì°¾ê¸°
      const clicked = await this.page.evaluate(() => {
        const buttons = Array.from(document.querySelectorAll('button, tp-yt-paper-button'));
        for (const btn of buttons) {
          const text = btn.textContent || btn.innerText;
          if (text && (text.includes('ë©¤ë²„ì‹­ ê´€ë¦¬') || text.includes('Manage membership'))) {
            btn.click();
            return true;
          }
        }
        return false;
      });
      
      if (clicked) {
        manageButtonClicked = true;
        this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ ì„±ê³µ (evaluate)', 'success');
      }
    }
    
    if (manageButtonClicked) {
      // ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ í›„ í˜ì´ì§€ ì—…ë°ì´íŠ¸ ëŒ€ê¸° (ì¼ì‹œì¤‘ì§€ì™€ ë™ì¼í•˜ê²Œ 7ì´ˆ)
      this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸° (7ì´ˆ)...', 'info');
      await new Promise(resolve => setTimeout(resolve, 7000));
      
      // í˜ì´ì§€ ì—…ë°ì´íŠ¸ í™•ì¸
      const pageUpdated = await this.page.evaluate(() => {
        const bodyText = document.body?.innerText || '';
        return bodyText.includes('Resume') || bodyText.includes('ì¬ê°œ') ||
               bodyText.includes('Pause') || bodyText.includes('ì¼ì‹œì¤‘ì§€');
      });
      
      if (pageUpdated) {
        this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
        this.managementPageOpened = true;
      } else {
        this.log('í˜ì´ì§€ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨, ê³„ì† ì§„í–‰', 'warning');
      }
    } else {
      this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ, ì¬ê°œ ë²„íŠ¼ ì§ì ‘ íƒìƒ‰', 'warning');
    }
    
    // í˜ì´ì§€ ë‚´ì—ì„œ ì¬ê°œ ê´€ë ¨ ìš”ì†Œ ì°¾ê¸°
    this.log('í˜ì´ì§€ ë‚´ì—ì„œ ì¬ê°œ ìš”ì†Œ íƒìƒ‰', 'info');
    
    const resumeInfo = await this.page.evaluate((resumeTexts) => {
      const result = {
        found: false,
        element: null,
        text: null,
        type: null
      };
      
      // ëª¨ë“  í…ìŠ¤íŠ¸ ìš”ì†Œ í™•ì¸
      const allElements = document.querySelectorAll('*');
      
      for (const el of allElements) {
        const text = el.textContent?.trim();
        
        // "ë©¤ë²„ì‹­ ì¬ê°œ" í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ìš”ì†Œ ì°¾ê¸°
        if (text && (text.includes('ë©¤ë²„ì‹­ ì¬ê°œ') || text.includes('Resume membership'))) {
          // í•´ë‹¹ ìš”ì†Œì˜ ìì‹ ìš”ì†Œ ì¤‘ í´ë¦­ ê°€ëŠ¥í•œ ë²„íŠ¼/ë§í¬ ì°¾ê¸°
          const clickableElements = el.querySelectorAll('button, a, [role="button"], [role="link"]');
          
          for (const clickable of clickableElements) {
            const clickableText = clickable.textContent?.trim();
            
            // ì¬ê°œ ë²„íŠ¼ ì°¾ê¸°
            if (clickableText && resumeTexts.some(resumeText => 
              clickableText === resumeText || clickableText.includes(resumeText)
            )) {
              result.found = true;
              result.text = clickableText;
              result.type = clickable.tagName.toLowerCase();
              
              // í´ë¦­
              if (clickable.offsetHeight > 0) {
                clickable.click();
                return result;
              }
            }
          }
        }
        
        // ë‹¨ë… "ì¬ê°œ" ë²„íŠ¼ ì°¾ê¸°
        if (text && resumeTexts.some(resumeText => text === resumeText)) {
          if (el.tagName === 'BUTTON' || el.tagName === 'A' || 
              el.getAttribute('role') === 'button') {
            
            result.found = true;
            result.text = text;
            result.type = el.tagName.toLowerCase();
            
            if (el.offsetHeight > 0) {
              el.click();
              return result;
            }
          }
        }
      }
      
      // ì°¾ì§€ ëª»í•œ ê²½ìš° ë” ë„“ì€ ê²€ìƒ‰
      if (!result.found) {
        // ëª¨ë“  ë²„íŠ¼ê³¼ ë§í¬ í™•ì¸
        const buttons = document.querySelectorAll('button, a[role="button"]');
        for (const btn of buttons) {
          const btnText = btn.textContent?.trim();
          if (btnText && resumeTexts.some(resumeText => 
            btnText === resumeText || btnText.includes(resumeText)
          )) {
            if (btn.offsetHeight > 0) {
              btn.click();
              result.found = true;
              result.text = btnText;
              result.type = btn.tagName.toLowerCase();
              return result;
            }
          }
        }
      }
      
      return result;
    }, lang.buttons.resume);
    
    if (resumeInfo.found) {
      this.log(`ì¬ê°œ ë²„íŠ¼ í´ë¦­ ì„±ê³µ: "${resumeInfo.text}" (${resumeInfo.type})`, 'success');
      await this.page.waitForTimeout(3000);
      return true;
    }
    
    // ì¬ê°œ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ìŠ¤í¬ë¡¤ ì‹œë„
    this.log('ì¬ê°œ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•¨. í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì‹œë„', 'warning');
    
    await this.page.evaluate(() => {
      window.scrollBy(0, 300);
    });
    
    await this.page.waitForTimeout(1000);
    
    // ìŠ¤í¬ë¡¤ í›„ ë‹¤ì‹œ ì‹œë„
    const resumeInfoAfterScroll = await this.page.evaluate((resumeTexts) => {
      const buttons = document.querySelectorAll('button, a[role="button"]');
      for (const btn of buttons) {
        const btnText = btn.textContent?.trim();
        if (btnText && resumeTexts.some(resumeText => 
          btnText === resumeText || btnText.includes(resumeText)
        )) {
          if (btn.offsetHeight > 0) {
            btn.click();
            return {
              found: true,
              text: btnText
            };
          }
        }
      }
      return { found: false };
    }, lang.buttons.resume);
    
    if (resumeInfoAfterScroll.found) {
      this.log(`ìŠ¤í¬ë¡¤ í›„ ì¬ê°œ ë²„íŠ¼ í´ë¦­ ì„±ê³µ: "${resumeInfoAfterScroll.text}"`, 'success');
      await this.page.waitForTimeout(3000);
      return true;
    }
    
    this.log('ì¬ê°œ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return false;
  }

  /**
   * íŒì—… í™•ì¸ ë° ë‚ ì§œ ì¶”ì¶œ (ì™„ì „í•œ ì›Œí¬í”Œë¡œìš° í†µí•© ë²„ì „)
   */
  async confirmResumeInPopup() {
    // íŒì—…ì´ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 8ì´ˆë¡œ ì¦ê°€)
    let popupFound = false;
    
    this.log('Resume íŒì—… ê°ì§€ ì¤‘... (ìµœëŒ€ 8ì´ˆ ëŒ€ê¸°)', 'info');
    
    for (let i = 0; i < 8; i++) {
      const hasPopup = await this.page.evaluate(() => {
        // ë‹¤ì–‘í•œ íŒì—… ì„ íƒì í™•ì¸ (í™•ì¥ëœ ëª©ë¡)
        const popupSelectors = [
          '[role="dialog"]:not([aria-hidden="true"])',
          '[aria-modal="true"]',
          'tp-yt-paper-dialog:not([aria-hidden="true"])',
          'ytd-popup-container',
          'tp-yt-iron-dropdown.opened',
          'yt-dialog',
          '.modal',
          '.popup',
          '.dialog',
          '[data-testid*="modal"]',
          '[data-testid*="dialog"]',
          '.opened'
        ];
        
        for (const selector of popupSelectors) {
          const elements = document.querySelectorAll(selector);
          for (const element of elements) {
            if (element.offsetHeight > 0 && element.offsetWidth > 0) {
              const text = element.textContent || '';
              // Resume ê´€ë ¨ í…ìŠ¤íŠ¸ í™•ì¸ (í™•ì¥ëœ í‚¤ì›Œë“œ)
              if (text.includes('Resume YouTube Premium') || 
                  text.includes('Resume') || text.includes('ì¬ê°œ') || 
                  text.includes('restart') || text.includes('ë‹¤ì‹œ ì‹œì‘') ||
                  text.includes('immediately') || text.includes('ì¦‰ì‹œ') ||
                  text.includes('Your membership will be resumed') ||
                  text.includes('ë©¤ë²„ì‹­ì´ ì¬ê°œë©ë‹ˆë‹¤')) {
                return true;
              }
            }
          }
        }
        
        // ì˜¤ë²„ë ˆì´ í™•ì¸
        const hasOverlay = !!document.querySelector('iron-overlay-backdrop:not([hidden])');
        if (hasOverlay) {
          console.log('ì˜¤ë²„ë ˆì´ ê°ì§€ë¨');
        }
        
        return false;
      });
      
      if (hasPopup) {
        popupFound = true;
        this.log('Resume íŒì—… ë°œê²¬!', 'success');
        break;
      }
      
      // ë§¤ ì´ˆë§ˆë‹¤ ìƒíƒœ ë¡œê¹…
      if (i % 2 === 0) {
        this.log(`íŒì—… ëŒ€ê¸° ì¤‘... (${i + 1}/8ì´ˆ)`, 'info');
      }
      
      await this.page.waitForTimeout(1000);
    }
    
    if (!popupFound) {
      this.log('ì¬ê°œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŒ', 'warning');
      
      // íŒì—… ì—†ì´ í˜ì´ì§€ê°€ ë°”ë¡œ ë³€ê²½ëœ ê²½ìš° í™•ì¸
      const pageChanged = await this.page.evaluate(() => {
        const bodyText = document.body?.innerText || '';
        return bodyText.includes('Pause membership') || 
               bodyText.includes('ë©¤ë²„ì‹­ ì¼ì‹œì¤‘ì§€') || 
               bodyText.includes('Your membership is active') ||
               bodyText.includes('ë©¤ë²„ì‹­ì´ í™œì„±');
      });
      
      if (pageChanged) {
        this.log('íŒì—… ì—†ì´ ì¬ê°œ ì„±ê³µ', 'success');
        return { confirmed: true, resumeDate: null, nextBillingDate: null };
      }
    }
    
    const lang = languages[this.currentLanguage];
    const result = {
      confirmed: false,
      resumeDate: null,
      nextBillingDate: null
    };
    
    // íŒì—… ë‚´ìš© ìƒì„¸ ë¡œê¹…
    const popupContent = await this.page.evaluate(() => {
      const popupSelectors = [
        '[role="dialog"]',
        '[aria-modal="true"]',
        'tp-yt-paper-dialog',
        'ytd-popup-container',
        'tp-yt-iron-dropdown',
        'yt-dialog',
        '.ytd-popup-container',
        '.opened'
      ];
      
      for (const selector of popupSelectors) {
        const elements = document.querySelectorAll(selector);
        for (const element of elements) {
          if (element.offsetHeight > 0 && element.offsetWidth > 0) {
            // ë²„íŠ¼ ì°¾ê¸°
            const buttonSelectors = [
              'button',
              'tp-yt-paper-button',
              '[role="button"]',
              'yt-button-renderer',
              'ytd-button-renderer',
              'a[role="button"]',
              '.yt-spec-button-shape-next'
            ];
            
            const buttons = [];
            for (const btnSelector of buttonSelectors) {
              const btns = element.querySelectorAll(btnSelector);
              btns.forEach(btn => {
                const text = btn.textContent?.trim();
                if (text && !buttons.includes(text)) {
                  buttons.push(text);
                }
              });
            }
            
            return {
              selector: selector,
              text: element.textContent?.substring(0, 500) || '',
              buttons: buttons,
              className: element.className,
              id: element.id || 'no-id'
            };
          }
        }
      }
      return null;
    });
    
    if (popupContent) {
      this.log(`ì¬ê°œ íŒì—… ì„ íƒì: ${popupContent.selector}`, 'debug');
      this.log(`ì¬ê°œ íŒì—… ID: ${popupContent.id}, í´ë˜ìŠ¤: ${popupContent.className}`, 'debug');
      this.log(`ì¬ê°œ íŒì—… ë‚´ìš©: ${popupContent.text.substring(0, 200)}...`, 'debug');
      this.log(`ì¬ê°œ íŒì—… ë²„íŠ¼ë“¤: ${popupContent.buttons.join(', ')}`, 'debug');
    }
    
    // íŒì—…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ ë° í™•ì¸ ë²„íŠ¼ í´ë¦­
    const popupResult = await this.page.evaluate((langData) => {
      console.log('ì¬ê°œ íŒì—… ë²„íŠ¼ ì°¾ê¸° ì‹œì‘...');
      
      const popupSelectors = [
        '[role="dialog"]',
        '[aria-modal="true"]',
        'tp-yt-paper-dialog',
        'ytd-popup-container',
        'tp-yt-iron-dropdown',
        'yt-dialog',
        '.opened'
      ];
      
      let dialog = null;
      for (const selector of popupSelectors) {
        const elements = document.querySelectorAll(selector);
        for (const element of elements) {
          if (element.offsetHeight > 0 && element.offsetWidth > 0) {
            const text = element.textContent || '';
            // Resume ê´€ë ¨ í…ìŠ¤íŠ¸ í™•ì¸
            if (text.includes('Resume') || text.includes('ì¬ê°œ') || 
                text.includes('restart') || text.includes('ë‹¤ì‹œ ì‹œì‘')) {
              dialog = element;
              console.log('í™œì„± ì¬ê°œ íŒì—… ì°¾ìŒ:', selector);
              break;
            }
          }
        }
        if (dialog) break;
      }
      
      if (dialog) {
        const popupText = dialog.textContent || '';
        const result = {
          hasPopup: true,
          clicked: false,
          dates: []
        };
        
        // ë‚ ì§œ ì¶”ì¶œ - ë‹¤ì–‘í•œ íŒ¨í„´
        const datePatterns = [
          // ì˜ì–´
          /(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2}/gi,
          /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\.?\s+\d{1,2}/gi,
          // ë² íŠ¸ë‚¨ì–´
          /\d{1,2}\s+thg\s+\d{1,2}/g,
          /\d{1,2}\s+thÃ¡ng\s+\d{1,2}/g,
          // í•œêµ­ì–´
          /\d{1,2}ì›”\s*\d{1,2}ì¼/g,
          // í„°í‚¤ì–´
          /\d{1,2}\s+(Ocak|Mart|Åubat|Nisan|MayÄ±s|Haziran|Temmuz|AÄŸustos|EylÃ¼l|Ekim|KasÄ±m|AralÄ±k)/gi,
          // ëŸ¬ì‹œì•„ì–´
          /\d{1,2}\s+(ÑĞ½Ğ²Ğ°Ñ€Ñ|Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ|Ğ¼Ğ°Ñ€Ñ‚Ğ°|Ğ°Ğ¿Ñ€ĞµĞ»Ñ|Ğ¼Ğ°Ñ|Ğ¸ÑĞ½Ñ|Ğ¸ÑĞ»Ñ|Ğ°Ğ²Ğ³ÑƒÑÑ‚Ğ°|ÑĞµĞ½Ñ‚ÑĞ±Ñ€Ñ|Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ|Ğ½Ğ¾ÑĞ±Ñ€Ñ|Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ)/gi,
          // ìˆ«ì í˜•ì‹
          /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,
          /\b\d{4}-\d{2}-\d{2}\b/g
        ];
        
        for (const pattern of datePatterns) {
          const matches = popupText.match(pattern);
          if (matches && matches.length > 0) {
            result.dates = result.dates.concat(matches);
          }
        }
        
        // ë²„íŠ¼ ì°¾ê¸° - ë‹¤ì–‘í•œ ì„ íƒì
        const buttonSelectors = [
          'button',
          'tp-yt-paper-button', 
          '[role="button"]',
          'yt-button-renderer button',
          'ytd-button-renderer button',
          '.yt-spec-button-shape-next',
          'a[role="button"]'
        ];
        
        const allButtons = [];
        for (const selector of buttonSelectors) {
          const buttons = dialog.querySelectorAll(selector);
          buttons.forEach(btn => {
            if (!allButtons.includes(btn)) {
              allButtons.push(btn);
            }
          });
        }
        
        console.log(`ì¬ê°œ íŒì—…ì—ì„œ ${allButtons.length}ê°œ ë²„íŠ¼ ë°œê²¬`);
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ìš°ì„ ìˆœìœ„ ëª©ë¡ (í™•ì¥ë¨)
        const buttonPriority = [
          // ì˜ì–´ (ì •í™•í•œ ë§¤ì¹­)
          'Resume',
          'Resume YouTube Premium',
          'Confirm',
          'Yes, resume',
          'OK',
          'Continue',
          'Yes',
          // í•œêµ­ì–´  
          'ì¬ê°œ',
          'YouTube Premium ì¬ê°œ',
          'í™•ì¸',
          'ì˜ˆ, ì¬ê°œ',
          'ê³„ì†',
          'ì˜ˆ',
          // ë² íŠ¸ë‚¨ì–´
          'Tiáº¿p tá»¥c',
          'KhÃ´i phá»¥c',
          // í„°í‚¤ì–´
          'Devam',
          'SÃ¼rdÃ¼r',
          // ëŸ¬ì‹œì•„ì–´
          'Ğ’Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ',
          'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ',
          // ë…ì¼ì–´
          'Fortsetzen',
          'Weiter',
          // í”„ë‘ìŠ¤ì–´
          'Reprendre',
          'Continuer',
          // ìŠ¤í˜ì¸ì–´
          'Reanudar',
          'Continuar',
          // ì¼ë³¸ì–´
          'å†é–‹',
          'ç¶šè¡Œ',
          // ì¤‘êµ­ì–´
          'æ¢å¤',
          'ç»§ç»­'
        ];
        
        // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ë²„íŠ¼ ì°¾ê¸°
        for (const targetText of buttonPriority) {
          for (const button of allButtons) {
            const btnText = button.textContent?.trim();
            
            if (btnText && (btnText === targetText || btnText.includes(targetText))) {
              console.log(`ì¬ê°œ íŒì—… ë²„íŠ¼ ë°œê²¬ ë° í´ë¦­: "${btnText}"`);
              
              // ë²„íŠ¼ì´ ë³´ì´ê³  í´ë¦­ ê°€ëŠ¥í•œì§€ í™•ì¸
              if (button.offsetHeight > 0 && button.offsetWidth > 0 && !button.disabled) {
                button.scrollIntoView({ behavior: 'instant', block: 'center' });
                button.click();
                result.clicked = true;
                console.log('ì¬ê°œ ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
                return result;
              } else {
                console.log('ë²„íŠ¼ì´ ë³´ì´ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ë¨:', btnText);
              }
            }
          }
        }
        
        // ì–¸ì–´ ë°ì´í„° ê¸°ë°˜ í™•ì¸ (fallback)
        console.log('ìš°ì„ ìˆœìœ„ ë§¤ì¹­ ì‹¤íŒ¨, ì–¸ì–´ ë°ì´í„° í™•ì¸...');
        for (const button of allButtons) {
          const btnText = button.textContent?.trim();
          
          if (!btnText) continue;
          
          // ì·¨ì†Œ ë²„íŠ¼ ì œì™¸
          if (btnText === 'ì·¨ì†Œ' || btnText.toLowerCase() === 'cancel' || btnText === 'Ä°ptal') {
            continue;
          }
          
          // Resume ê´€ë ¨ í…ìŠ¤íŠ¸ í™•ì¸
          for (const resumeText of langData.buttons.resume) {
            if (btnText === resumeText || btnText.includes(resumeText)) {
              console.log(`ì¬ê°œ íŒì—… ë²„íŠ¼ í´ë¦­ (ì–¸ì–´ ë°ì´í„°): "${btnText}"`);
              
              if (button.offsetHeight > 0 && button.offsetWidth > 0 && !button.disabled) {
                button.scrollIntoView({ behavior: 'instant', block: 'center' });
                button.click();
                result.clicked = true;
                return result;
              }
            }
          }
        }
        
        // ëª¨ë“  ë²„íŠ¼ ì •ë³´ ë¡œê¹… (ë””ë²„ê¹…)
        console.log('ì í•©í•œ ì¬ê°œ ë²„íŠ¼ì„ ì°¾ì§€ ëª»í•¨. ëª¨ë“  ë²„íŠ¼ í…ìŠ¤íŠ¸:');
        allButtons.forEach((btn, index) => {
          const text = btn.textContent?.trim();
          if (text) {
            console.log(`  ${index + 1}. "${text}" (visible: ${btn.offsetHeight > 0}, disabled: ${btn.disabled})`);
          }
        });
      } else {
        console.log('í™œì„± ì¬ê°œ íŒì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }
      
      return { hasPopup: false, clicked: false };
    }, lang);
    
    if (popupResult.clicked) {
      this.log('ì¬ê°œ íŒì—… ë²„íŠ¼ í´ë¦­ ì„±ê³µ!', 'success');
      result.confirmed = true;
      
      if (popupResult.dates && popupResult.dates.length > 0) {
        this.log(`ì¬ê°œ íŒì—…ì—ì„œ ì¶”ì¶œëœ ë‚ ì§œ: ${popupResult.dates.join(', ')}`, 'info');
        result.resumeDate = parseDate(popupResult.dates[0], this.currentLanguage);
        if (popupResult.dates.length > 1) {
          result.nextBillingDate = parseDate(popupResult.dates[1], this.currentLanguage);
        }
      } else {
        this.log('ì¬ê°œ íŒì—…ì—ì„œ ë‚ ì§œë¥¼ ì°¾ì§€ ëª»í•¨ - ì •ìƒì ì¸ ê²½ìš°ì¼ ìˆ˜ ìˆìŒ', 'warning');
      }
      
      await this.page.waitForTimeout(5000);
    } else {
      this.log('ì¬ê°œ íŒì—… ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨', 'error');
      
      // ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦°ìƒ· ì €ì¥
      try {
        const timestamp = Date.now();
        await this.page.screenshot({ 
          path: `resume_popup_error_${timestamp}.png`,
          fullPage: false
        });
        this.log(`ì¬ê°œ íŒì—… ì˜¤ë¥˜ ìŠ¤í¬ë¦°ìƒ· ì €ì¥: resume_popup_error_${timestamp}.png`, 'debug');
      } catch (e) {
        // ë¬´ì‹œ
      }
    }
    
    return result;
  }

  /**
   * ì¬ê°œ ì„±ê³µ í™•ì¸ (ì¼ì‹œì¤‘ì§€ ì›Œí¬í”Œë¡œìš° ì°¸ì¡° ê°œì„ )
   */
  async verifyResumeSuccess() {
    // [ì¤‘ìš” ê°œì„ ] ì¼ì‹œì¤‘ì§€ ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•˜ê²Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë° ì¬í´ë¦­ ì¶”ê°€
    this.log('ì¬ê°œ ì„±ê³µ ê²€ì¦ ì‹œì‘ - í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨', 'info');
    
    // 1. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì¼ì‹œì¤‘ì§€ì™€ ë™ì¼)
    await this.page.goto('https://www.youtube.com/paid_memberships', {
      waitUntil: 'domcontentloaded',
      timeout: 15000
    });
    await this.page.waitForTimeout(3000);
    
    // 2. ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ ì¬í´ë¦­ (ì¼ì‹œì¤‘ì§€ì™€ ë™ì¼)
    this.log('ë©¤ë²„ì‹­ ê´€ë¦¬ ë²„íŠ¼ ì¬í´ë¦­', 'info');
    await this.clickManageButton();
    
    const lang = languages[this.currentLanguage];
    
    // ì¬ê°œ ì„±ê³µ í™•ì¸ - ì—¬ëŸ¬ ì¡°ê±´ì„ ì²´í¬
    const status = await this.page.evaluate((langData) => {
      const result = {
        success: false,
        nextBillingDate: null,
        hasResumeButton: false,
        hasPauseButton: false,
        hasNextBillingText: false,
        pageText: document.body?.textContent || ''
      };
      
      // 1. Resume ë²„íŠ¼ì´ ì‚¬ë¼ì¡ŒëŠ”ì§€ í™•ì¸ (ì¬ê°œëœ ì¦ê±°)
      const buttons = document.querySelectorAll('button, [role="button"], yt-button-renderer, tp-yt-paper-button');
      for (const btn of buttons) {
        const btnText = btn.textContent?.trim();
        if (!btnText) continue;
        
        // Resume ë²„íŠ¼ ì²´í¬
        if (langData.buttons.resume.some(resumeText => {
          return btnText === resumeText || btnText.includes(resumeText);
        })) {
          if (btn.offsetHeight > 0) {
            result.hasResumeButton = true;
          }
        }
        
        // Pause ë²„íŠ¼ ì²´í¬
        if (langData.buttons.pause.some(pauseText => {
          return btnText === pauseText || btnText.includes(pauseText);
        })) {
          if (btn.offsetHeight > 0) {
            result.hasPauseButton = true;
          }
        }
      }
      
      // 2. ë©”ë‰´ ì•„ì´í…œ í™•ì¸
      const menuItems = document.querySelectorAll('[role="menuitem"], ytd-menu-navigation-item-renderer, tp-yt-paper-item');
      for (const item of menuItems) {
        const itemText = item.textContent?.trim();
        if (!itemText) continue;
        
        if (langData.buttons.pause.some(pauseText => itemText.includes(pauseText))) {
          result.hasPauseButton = true;
        }
        if (langData.buttons.resume.some(resumeText => itemText.includes(resumeText))) {
          result.hasResumeButton = true;
        }
      }
      
      // 3. í˜ì´ì§€ í…ìŠ¤íŠ¸ì—ì„œ í™œì„±í™” ê´€ë ¨ í‚¤ì›Œë“œ í™•ì¸ (ë‹¤êµ­ì–´ ì§€ì›)
      const activeKeywords = [
        // í•œêµ­ì–´
        'í™œì„±', 'ë‹¤ìŒ ê²°ì œì¼', 'ìë™ ê°±ì‹ ', 'ë‹¤ìŒ ê²°ì œ',
        // ì˜ì–´
        'Active', 'Next billing', 'Auto-renew', 'Next billing date',
        // í„°í‚¤ì–´
        'Aktif', 'Sonraki faturalandÄ±rma',
        // ëŸ¬ì‹œì•„ì–´  
        'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°', 'Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶',
        // ë² íŠ¸ë‚¨ì–´
        'Äang hoáº¡t Ä‘á»™ng', 'Thanh toÃ¡n tiáº¿p theo'
      ];
      
      const pausedKeywords = [
        // í•œêµ­ì–´
        'ì¼ì‹œì¤‘ì§€ë¨', 'ì¼ì‹œ ì¤‘ì§€', 'ì¬ê°œí•˜ë ¤ë©´', 'ë©¤ë²„ì‹­ì´ ì¼ì‹œì¤‘ì§€',
        // ì˜ì–´
        'Paused', 'To resume', 'Membership pauses', 'is paused',
        // í„°í‚¤ì–´
        'DuraklatÄ±ldÄ±',
        // ëŸ¬ì‹œì•„ì–´
        'ĞŸÑ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾',
        // ë² íŠ¸ë‚¨ì–´  
        'ÄÃ£ táº¡m dá»«ng', 'Táº¡m dá»«ng'
      ];
      
      // "Next billing date:" í…ìŠ¤íŠ¸ íŒ¨í„´ í™•ì¸ (ì¤‘ìš”)
      const nextBillingPatterns = [
        'Next billing date:', 'ë‹¤ìŒ ê²°ì œì¼:', 'Sonraki faturalandÄ±rma:',
        'Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶:', 'Thanh toÃ¡n tiáº¿p theo:'
      ];
      
      const hasActiveKeyword = activeKeywords.some(keyword => 
        result.pageText.includes(keyword)
      );
      const hasPausedKeyword = pausedKeywords.some(keyword => 
        result.pageText.includes(keyword)
      );
      const hasNextBillingText = nextBillingPatterns.some(pattern =>
        result.pageText.includes(pattern)
      );
      
      result.hasNextBillingText = hasNextBillingText;
      
      // ì¬ê°œ ì„±ê³µ íŒë‹¨ ë¡œì§ (ê°œì„ )
      // 1. Resume ë²„íŠ¼ì´ ì—†ê³  Pause ë²„íŠ¼ì´ ìˆìœ¼ë©´ ì„±ê³µ
      // 2. ë˜ëŠ” "Next billing date:" í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì„±ê³µ
      // 3. ë˜ëŠ” í™œì„± í‚¤ì›Œë“œê°€ ìˆê³  ì¼ì‹œì¤‘ì§€ í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ì„±ê³µ
      if (!result.hasResumeButton) {
        if (result.hasPauseButton || hasNextBillingText || (hasActiveKeyword && !hasPausedKeyword)) {
          result.success = true;
        }
      }
      
      // ë‚ ì§œ ì¶”ì¶œ (ë‹¤êµ­ì–´ ì§€ì› ê°•í™”)
      const datePatterns = [
        // ì˜ì–´
        /(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s*\d{4}/i,
        /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\.?\s+\d{1,2}/i,
        // í•œêµ­ì–´
        /\d{1,2}ì›”\s*\d{1,2}ì¼/,
        /\d{4}ë…„\s*\d{1,2}ì›”\s*\d{1,2}ì¼/,
        // ë² íŠ¸ë‚¨ì–´
        /\d{1,2}\s+thg\s+\d{1,2}/,
        /\d{1,2}\s+thÃ¡ng\s+\d{1,2}/,
        // í„°í‚¤ì–´
        /\d{1,2}\s+(Ocak|Mart|Åubat|Nisan|MayÄ±s|Haziran|Temmuz|AÄŸustos|EylÃ¼l|Ekim|KasÄ±m|AralÄ±k)/i,
        // ëŸ¬ì‹œì•„ì–´
        /\d{1,2}\s+(ÑĞ½Ğ²Ğ°Ñ€Ñ|Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ|Ğ¼Ğ°Ñ€Ñ‚Ğ°|Ğ°Ğ¿Ñ€ĞµĞ»Ñ|Ğ¼Ğ°Ñ|Ğ¸ÑĞ½Ñ|Ğ¸ÑĞ»Ñ|Ğ°Ğ²Ğ³ÑƒÑÑ‚Ğ°|ÑĞµĞ½Ñ‚ÑĞ±Ñ€Ñ|Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ|Ğ½Ğ¾ÑĞ±Ñ€Ñ|Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ)/i,
        // ìˆ«ì í˜•ì‹
        /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/,
        /\b\d{4}-\d{2}-\d{2}\b/
      ];
      
      for (const pattern of datePatterns) {
        const dateMatch = result.pageText.match(pattern);
        if (dateMatch) {
          result.nextBillingDate = dateMatch[0];
          break;
        }
      }
      
      return result;
    }, lang);
    
    this.log(`ê²€ì¦ ê²°ê³¼: Resume ë²„íŠ¼=${status.hasResumeButton}, Pause ë²„íŠ¼=${status.hasPauseButton}, Next billing í…ìŠ¤íŠ¸=${status.hasNextBillingText}`, 'info');
    
    if (status.nextBillingDate) {
      status.nextBillingDate = parseDate(status.nextBillingDate, this.currentLanguage);
    }
    
    return status;
  }

  /**
   * Google Sheets ì—…ë°ì´íŠ¸ (ê²°ì œì¬ê°œ íƒ­)
   */
  async updateGoogleSheets(profileId, result) {
    try {
      if (!this.pauseSheetRepository) {
        this.log('Google Sheets Repositoryê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ', 'warning');
        return;
      }

      await this.pauseSheetRepository.initialize();
      
      // ì´ë©”ì¼ë¡œ ê²€ìƒ‰í•˜ë„ë¡ ë³€ê²½ (ì¼ì‹œì¤‘ì§€ ì‘ì—…ê³¼ ë™ì¼í•œ ë¡œì§)
      const email = this.profileData?.email || this.profileData?.googleId;
      if (!email) {
        this.log('ì´ë©”ì¼ ì •ë³´ê°€ ì—†ì–´ í”„ë¡œí•„ IDë¡œ ì‹œë„', 'warning');
        // emailì´ ì—†ìœ¼ë©´ í”„ë¡œí•„ IDë¡œ fallback
      }
      
      const searchIdentifier = email || profileId;
      this.log(`Google Sheets ê²€ìƒ‰ ì‹ë³„ì: ${searchIdentifier} (íƒ€ì…: ${email ? 'ì´ë©”ì¼' : 'í”„ë¡œí•„ID'})`, 'info');
      
      let updateData;
      
      // reCAPTCHA ê°ì§€ëœ ê²½ìš°
      if (result.status === 'recaptcha_required') {
        updateData = {
          result: 'ë²ˆí˜¸ì¸ì¦ê³„ì •',
          ipAddress: result.browserIP || 'N/A'
          // ìƒíƒœëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ
        };
      } else if (result.success) {
        updateData = {
          status: 'ê²°ì œì¤‘',  // êµ¬ë…ì¬ê°œ ì„±ê³µ ì‹œ 'ê²°ì œì¤‘'ìœ¼ë¡œ ë³€ê²½
          result: 'ì¬ê°œ ì„±ê³µ',
          nextBillingDate: result.nextBillingDate,
          ipAddress: result.browserIP || 'N/A'
        };
      } else {
        updateData = {
          result: result.error || 'ì‹¤íŒ¨',
          ipAddress: result.browserIP || 'N/A'
          // êµ¬ë…ì¬ê°œ ì‹¤íŒ¨ ì‹œ ìƒíƒœëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ (ë³€í™”ì—†ìŒ)
        };
      }
      
      // ê²°ì œì¬ê°œ íƒ­ ì—…ë°ì´íŠ¸ (ì´ë©”ì¼ë¡œ ê²€ìƒ‰)
      const updated = await this.pauseSheetRepository.updateResumeStatus(searchIdentifier, updateData);
      
      if (updated) {
        this.log('ê²°ì œì¬ê°œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ', 'success');
      } else {
        this.log('ê²°ì œì¬ê°œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', 'warning');
      }
    } catch (error) {
      this.log(`ê²°ì œì¬ê°œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  /**
   * ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜
   */
  async captureScreenshot(profileId, result) {
    try {
      if (!this.page) {
        this.log('ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì‹¤íŒ¨: í˜ì´ì§€ ê°ì²´ ì—†ìŒ', 'warning');
        return;
      }

      // ìŠ¤í¬ë¦°ìƒ· ë””ë ‰í† ë¦¬ ìƒì„±
      const screenshotDir = path.join(process.cwd(), 'logs', 'screenshots');
      await fs.mkdir(screenshotDir, { recursive: true });

      // íŒŒì¼ëª… ìƒì„±: ë‚ ì§œ-ì‹œê°„-ê³„ì •ì•„ì´ë””
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
      const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // HH-MM-SS
      const email = this.profileData.email || this.profileData.googleId || 'unknown';
      const cleanEmail = email.replace(/@.*/, ''); // @ ì´í›„ ì œê±°
      const status = result.success ? 'success' : 'failed';
      
      const filename = `${dateStr}_${timeStr}_${cleanEmail}_${status}.png`;
      const filepath = path.join(screenshotDir, filename);

      // ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜
      await this.page.screenshot({
        path: filepath,
        fullPage: false // í˜„ì¬ ë³´ì´ëŠ” í™”ë©´ë§Œ
      });

      this.log(`ğŸ“· ìŠ¤í¬ë¦°ìƒ· ì €ì¥: ${filename}`, 'success');
      
      // Loggerê°€ ìˆìœ¼ë©´ ë¡œê¹…
      if (this.logger && typeof this.logger.info === 'function') {
        await this.logger.info(`ìŠ¤í¬ë¦°ìƒ· ì €ì¥ë¨`, {
          profileId,
          email,
          filename,
          path: filepath,
          status
        });
      }
      
    } catch (error) {
      this.log(`ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì˜¤ë¥˜: ${error.message}`, 'error');
    }
  }

  /**
   * ë¸Œë¼ìš°ì € IP í™•ì¸ (ì‹ ê·œ ì¶”ê°€)
   */
  async checkBrowserIP() {
    try {
      this.log('ë¸Œë¼ìš°ì € IP í™•ì¸ ì¤‘...', 'info');
      
      // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ IP í™•ì¸ ì‹œë„
      const ipCheckMethods = [
        // ë°©ë²• 1: ë¸Œë¼ìš°ì € ë‚´ì—ì„œ fetch API ì‚¬ìš©
        async () => {
          return await this.page.evaluate(async () => {
            try {
              const response = await fetch('https://api.ipify.org?format=json', {
                timeout: 8000
              });
              const data = await response.json();
              return data.ip;
            } catch (e) {
              return null;
            }
          });
        },
        
        // ë°©ë²• 2: ë¸Œë¼ìš°ì €ì—ì„œ ë‹¤ë¥¸ API ì‹œë„
        async () => {
          return await this.page.evaluate(async () => {
            try {
              const response = await fetch('https://api.my-ip.io/ip');
              const ip = await response.text();
              return ip.trim();
            } catch (e) {
              return null;
            }
          });
        },
        
        // ë°©ë²• 3: PauseSheetRepositoryì˜ getIPAddress ë©”ì„œë“œ ì‚¬ìš©
        async () => {
          if (this.pauseSheetRepository) {
            return await this.pauseSheetRepository.getIPAddress();
          }
          return null;
        },
        
        // ë°©ë²• 4: Node.jsì—ì„œ ì§ì ‘ axios ì‚¬ìš©
        async () => {
          try {
            const axios = require('axios');
            const response = await axios.get('https://api.ipify.org?format=json', {
              timeout: 8000
            });
            return response.data.ip;
          } catch (e) {
            return null;
          }
        }
      ];
      
      // ìˆœì°¨ì ìœ¼ë¡œ IP í™•ì¸ ë°©ë²• ì‹œë„
      for (let i = 0; i < ipCheckMethods.length; i++) {
        try {
          this.log(`IP í™•ì¸ ë°©ë²• ${i + 1}/${ipCheckMethods.length} ì‹œë„ ì¤‘...`, 'info');
          const ip = await ipCheckMethods[i]();
          
          if (ip && ip !== 'Unknown' && ip.length > 0 && ip.match(/^\d+\.\d+\.\d+\.\d+$/)) {
            this.log(`âœ… ë¸Œë¼ìš°ì € IP í™•ì¸ ì„±ê³µ: ${ip} (ë°©ë²• ${i + 1})`, 'success');
            return ip;
          }
        } catch (error) {
          this.log(`IP í™•ì¸ ë°©ë²• ${i + 1} ì‹¤íŒ¨: ${error.message}`, 'warning');
        }
      }
      
      this.log('âŒ ëª¨ë“  IP í™•ì¸ ë°©ë²• ì‹¤íŒ¨', 'warning');
      return 'N/A';
      
    } catch (error) {
      this.log(`IP í™•ì¸ ì¹˜ëª…ì  ì˜¤ë¥˜: ${error.message}`, 'error');
      return 'N/A';
    }
  }
  
  /**
   * ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ
   */
  async disconnectBrowser(profileId) {
    try {
      if (profileId) {
        await this.adsPowerAdapter.closeBrowser(profileId);
      }
      this.browser = null;
      this.page = null;
      this.controller = null; // controllerë„ ì •ë¦¬
    } catch (error) {
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œì»¬ ì°¸ì¡°ëŠ” ì •ë¦¬
      this.browser = null;
      this.page = null;
      this.controller = null;
      this.log(`ë¸Œë¼ìš°ì € ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ): ${error.message}`, 'debug');
    }
  }

  /**
   * ë¡œê·¸ ì¶œë ¥
   */
  log(message, type = 'info') {
    const colors = {
      info: chalk.cyan,
      success: chalk.green,
      warning: chalk.yellow,
      error: chalk.red
    };
    
    const color = colors[type] || chalk.white;
    const prefix = type === 'success' ? 'âœ…' : 
                   type === 'error' ? 'âŒ' : 
                   type === 'warning' ? 'âš ï¸' : 'ğŸ“Œ';
    
    if (this.logger && this.logger.log) {
      this.logger.log(color(`${prefix} ${message}`));
    } else {
      console.log(color(`${prefix} ${message}`));
    }
  }
}

module.exports = EnhancedResumeSubscriptionUseCase;