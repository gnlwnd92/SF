/**
 * Google Login Helper Ultimate
 * AdsPower ë¸Œë¼ìš°ì €ì—ì„œ í´ë¦­ ë¬¸ì œë¥¼ í•´ê²°í•œ ìµœì¢… ë²„ì „
 */

const chalk = require('chalk');
const AdvancedClickHelper = require('./AdvancedClickHelper');

class GoogleLoginHelperUltimate {
  constructor(page, browserController, config = {}) {
    this.page = page;
    this.controller = browserController;
    this.config = {
      debugMode: config.debugMode || false,
      screenshotEnabled: config.screenshotEnabled !== false,
      maxRetries: config.maxRetries || 3,
      ...config
    };
    
    // Advanced Click Helper ì´ˆê¸°í™”
    this.clickHelper = new AdvancedClickHelper(page, {
      debugMode: this.config.debugMode
    });
  }

  /**
   * í”„ë ˆì„ ì¤€ë¹„ í™•ì¸
   */
  async ensureFrameReady() {
    try {
      if (!this.page) {
        throw new Error('Page object not available');
      }

      // í˜ì´ì§€ê°€ ë‹«í˜”ëŠ”ì§€ í™•ì¸
      try {
        await this.page.evaluate(() => true);
      } catch (error) {
        if (error.message.includes('Session closed') || 
            error.message.includes('Page has been closed')) {
          throw new Error('Page has been closed');
        }
      }

      await this.page.waitForTimeout(500);
      
      try {
        await this.page.waitForFunction(
          () => document.readyState === 'complete' || document.readyState === 'interactive',
          { timeout: 5000 }
        );
      } catch (e) {
        console.log(chalk.yellow('âš ï¸ DOM ë¡œë“œ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼, ê³„ì† ì§„í–‰'));
      }

      return true;
    } catch (error) {
      console.error(chalk.red('í”„ë ˆì„ ì¤€ë¹„ í™•ì¸ ì‹¤íŒ¨:'), error.message);
      throw error;
    }
  }

  /**
   * ì•ˆì „í•œ evaluate ì‹¤í–‰
   */
  async safeEvaluate(fn, ...args) {
    try {
      await this.ensureFrameReady();
      return await this.page.evaluate(fn, ...args);
    } catch (error) {
      if (error.message.includes('Requesting main frame too early')) {
        console.log(chalk.yellow('âš ï¸ í”„ë ˆì„ ì¤€ë¹„ ëŒ€ê¸° ì¤‘...'));
        await this.page.waitForTimeout(2000);
        
        try {
          await this.ensureFrameReady();
          return await this.page.evaluate(fn, ...args);
        } catch (retryError) {
          console.error(chalk.red('ì¬ì‹œë„ ì‹¤íŒ¨:'), retryError.message);
          throw retryError;
        }
      }
      throw error;
    }
  }

  /**
   * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
   */
  async checkLoginStatus() {
    try {
      await this.ensureFrameReady();
      const currentUrl = this.page.url();
      
      const loginPagePatterns = [
        'accounts.google.com/signin',
        'accounts.google.com/v3/signin',
        'accounts.google.com/ServiceLogin',
        'accounts.google.com/identifier',
        'accounts.google.com/accountchooser'
      ];
      
      const isLoginPage = loginPagePatterns.some(pattern => 
        currentUrl.includes(pattern)
      );
      
      if (isLoginPage) {
        if (this.config.debugMode) {
          console.log(chalk.yellow('ğŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•œ ìƒíƒœì…ë‹ˆë‹¤.'));
        }
        return false;
      }
      
      if (currentUrl.includes('youtube.com')) {
        const loginCheck = await this.safeEvaluate(() => {
          const result = {
            isLoggedIn: false,
            indicators: []
          };
          
          const avatarElements = document.querySelectorAll(
            '#avatar-btn, button#avatar-btn, img.yt-img-shadow, ' +
            'button[aria-label*="Account"], button[aria-label*="ê³„ì •"]'
          );
          
          if (avatarElements.length > 0) {
            result.indicators.push('ì•„ë°”íƒ€ ë²„íŠ¼ ì¡´ì¬');
          }
          
          const signInLinks = document.querySelectorAll(
            'a[href*="accounts.google.com/ServiceLogin"], ' +
            'a[aria-label*="Sign in"], a[aria-label*="ë¡œê·¸ì¸"]'
          );
          
          if (signInLinks.length === 0) {
            result.indicators.push('ë¡œê·¸ì¸ ë§í¬ ì—†ìŒ');
          }
          
          const pageText = document.body?.textContent || '';
          const hasMembershipContent = 
            pageText.includes('Manage membership') || 
            pageText.includes('êµ¬ë… ê´€ë¦¬') ||
            pageText.includes('Premium');
            
          if (hasMembershipContent) {
            result.indicators.push('ë©¤ë²„ì‹­ ì½˜í…ì¸  ì¡´ì¬');
          }
          
          result.isLoggedIn = result.indicators.length >= 2;
          
          return result;
        });
        
        if (this.config.debugMode) {
          if (loginCheck.isLoggedIn) {
            console.log(chalk.green('âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨'));
            if (loginCheck.indicators.length > 0) {
              console.log(chalk.gray('  ê·¼ê±°: ' + loginCheck.indicators.join(', ')));
            }
          } else {
            console.log(chalk.yellow('âš ï¸ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ'));
          }
        }
        
        return loginCheck.isLoggedIn;
      }
      
      return true;
      
    } catch (error) {
      console.error(chalk.red('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
   */
  async login(credentials) {
    if (!credentials || !credentials.email || !credentials.password) {
      throw new Error('ë¡œê·¸ì¸ ìê²© ì¦ëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    console.log(chalk.blue(`\nğŸ” Google ê³„ì • ë¡œê·¸ì¸ ì‹œì‘: ${credentials.email}`));
    
    try {
      await this.ensureFrameReady();
      
      const currentUrl = this.page.url();
      console.log(chalk.gray(`í˜„ì¬ URL: ${currentUrl}`));
      
      // ì´ë©”ì¼ ì…ë ¥ ë‹¨ê³„ ì²˜ë¦¬
      const emailStepCompleted = await this.handleEmailStep(credentials.email);
      if (emailStepCompleted) {
        console.log(chalk.green('âœ… ì´ë©”ì¼ ë‹¨ê³„ ì™„ë£Œ'));
        
        await this.page.waitForTimeout(3000);
        
        const hasRecaptcha = await this.checkForRecaptcha();
        if (hasRecaptcha) {
          console.log(chalk.yellow('âš ï¸ reCAPTCHA ê°ì§€ë¨ - ìˆ˜ë™ ì¸ì¦ í•„ìš”'));
          return 'RECAPTCHA_DETECTED';
        }
      } else {
        console.log(chalk.red('âŒ ì´ë©”ì¼ ë‹¨ê³„ ì‹¤íŒ¨'));
        return false;
      }
      
      // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë‹¨ê³„ ì²˜ë¦¬
      const passwordStepCompleted = await this.handlePasswordStep(credentials.password);
      if (passwordStepCompleted) {
        console.log(chalk.green('âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ'));
        
        await this.page.waitForTimeout(2000 + Math.random() * 1000);
        
        const hasRecaptcha = await this.checkForRecaptcha();
        if (hasRecaptcha) {
          console.log(chalk.yellow('âš ï¸ reCAPTCHA ê°ì§€ë¨ - ìˆ˜ë™ ì¸ì¦ í•„ìš”'));
          return 'RECAPTCHA_DETECTED';
        }
      }
      
      await this.handle2FAIfNeeded(credentials);
      await this.waitForLoginComplete();
      
      const loginSuccess = await this.checkLoginStatus();
      
      if (loginSuccess) {
        console.log(chalk.green('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ'));
        return true;
      } else {
        console.log(chalk.red('âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨'));
        return false;
      }
      
    } catch (error) {
      console.error(chalk.red('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:'), error.message);
      
      if (this.config.screenshotEnabled) {
        try {
          await this.page.screenshot({
            path: `screenshots/login_error_${Date.now()}.png`
          });
        } catch (e) {
          console.log(chalk.yellow('ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì‹¤íŒ¨'));
        }
      }
      
      return false;
    }
  }

  /**
   * ì´ë©”ì¼ ì…ë ¥ ë‹¨ê³„ ì²˜ë¦¬ (Ultimate ë²„ì „)
   */
  async handleEmailStep(email) {
    try {
      await this.ensureFrameReady();
      await this.page.waitForTimeout(2000);
      
      const currentUrl = this.page.url();
      console.log(chalk.gray(`ì´ë©”ì¼ ë‹¨ê³„ URL: ${currentUrl}`));
      
      // ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬
      if (currentUrl.includes('accountchooser')) {
        console.log(chalk.cyan('\nğŸ“‹ ê³„ì • ì„ íƒ í˜ì´ì§€ ì²˜ë¦¬'));
        
        // 1. ë¨¼ì € í˜„ì¬ ê³„ì •ì´ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
        const existingAccountClicked = await this.selectExistingAccount(email);
        
        if (existingAccountClicked) {
          console.log(chalk.green('âœ… ê¸°ì¡´ ê³„ì • ì„ íƒ ì„±ê³µ'));
          
          // í˜ì´ì§€ ì „í™˜ ëŒ€ê¸°
          try {
            await this.page.waitForNavigation({ 
              waitUntil: 'domcontentloaded', 
              timeout: 5000 
            });
          } catch (e) {
            await this.page.waitForTimeout(3000);
          }
          
          return true;
        }
        
        // 2. ê³„ì •ì´ ì—†ìœ¼ë©´ "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" í´ë¦­
        console.log(chalk.yellow('ê³„ì •ì´ ëª©ë¡ì— ì—†ìŒ, "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" í´ë¦­ ì‹œë„'));
        
        // ê°€ëŠ¥í•œ ëª¨ë“  ì„ íƒì
        const addAccountSelectors = [
          'div[jsname="rwl3qc"]',
          'div[data-identifier=""]',
          'li[jsname="XraQ3b"]',
          'div[role="link"]:last-child',
          'li:last-child',
          'div:contains("Use another account")',
          'div:contains("ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©")',
          'button:contains("Add account")',
          'button:contains("ê³„ì • ì¶”ê°€")'
        ];
        
        let addAccountClicked = false;
        
        for (const selector of addAccountSelectors) {
          const clicked = await this.clickHelper.clickElement(selector);
          if (clicked) {
            addAccountClicked = true;
            console.log(chalk.green(`âœ… "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" í´ë¦­ ì„±ê³µ: ${selector}`));
            break;
          }
        }
        
        // 3. ì„ íƒìë¡œ ëª» ì°¾ìœ¼ë©´ í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸°
        if (!addAccountClicked) {
          console.log(chalk.yellow('ì„ íƒìë¡œ ëª» ì°¾ìŒ, í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰'));
          
          const textClicked = await this.clickByText(['Use another account', 'ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©', 'Add account', 'ê³„ì • ì¶”ê°€']);
          if (textClicked) {
            addAccountClicked = true;
            console.log(chalk.green('âœ… í…ìŠ¤íŠ¸ë¡œ "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" í´ë¦­ ì„±ê³µ'));
          }
        }
        
        if (!addAccountClicked) {
          console.log(chalk.red('âŒ "ë‹¤ë¥¸ ê³„ì • ì‚¬ìš©" ë²„íŠ¼ì„ í´ë¦­í•  ìˆ˜ ì—†ìŒ'));
          
          // ë””ë²„ê·¸: í˜ì´ì§€ì˜ ëª¨ë“  í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œ ì¶œë ¥
          if (this.config.debugMode) {
            await this.debugClickableElements();
          }
          
          return false;
        }
        
        // í˜ì´ì§€ ì „í™˜ ëŒ€ê¸°
        await this.page.waitForTimeout(3000);
      }
      
      // ì´ë©”ì¼ ì…ë ¥ í•„ë“œ ì°¾ê¸° ë° ì…ë ¥
      const emailInputSuccess = await this.enterEmail(email);
      
      if (!emailInputSuccess) {
        console.log(chalk.red('âŒ ì´ë©”ì¼ ì…ë ¥ ì‹¤íŒ¨'));
        return false;
      }
      
      // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
      const nextButtonClicked = await this.clickNextButton();
      
      if (!nextButtonClicked) {
        console.log(chalk.gray('Enter í‚¤ë¡œ ì§„í–‰'));
        await this.page.keyboard.press('Enter');
      }
      
      await this.page.waitForTimeout(3000);
      
      return true;
      
    } catch (error) {
      console.error(chalk.red('ì´ë©”ì¼ ì…ë ¥ ë‹¨ê³„ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * ê¸°ì¡´ ê³„ì • ì„ íƒ
   */
  async selectExistingAccount(targetEmail) {
    try {
      // data-identifier ì†ì„±ìœ¼ë¡œ ì°¾ê¸°
      const accountSelector = `div[data-identifier="${targetEmail}"]`;
      const accountElement = await this.page.$(accountSelector);
      
      if (accountElement) {
        console.log(chalk.gray(`ê³„ì • ë°œê²¬: ${targetEmail}`));
        
        const clicked = await this.clickHelper.clickElement(accountSelector);
        if (clicked) {
          return true;
        }
      }
      
      // í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸°
      const elements = await this.page.$$('div[role="link"], li[role="presentation"]');
      
      for (const element of elements) {
        const text = await element.evaluate(el => el.textContent);
        
        if (text && text.includes(targetEmail)) {
          console.log(chalk.gray(`í…ìŠ¤íŠ¸ë¡œ ê³„ì • ë°œê²¬: ${targetEmail}`));
          
          // AdvancedClickHelper ì‚¬ìš©
          const clicked = await this.clickHelper.clickElement(element);
          if (clicked) {
            return true;
          }
        }
      }
      
      return false;
      
    } catch (error) {
      console.error(chalk.red('ê³„ì • ì„ íƒ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * í…ìŠ¤íŠ¸ë¡œ ìš”ì†Œ ì°¾ì•„ì„œ í´ë¦­
   */
  async clickByText(textArray) {
    try {
      const elements = await this.page.$$('div, li, button, a');
      
      for (const element of elements) {
        const text = await element.evaluate(el => el.textContent?.trim());
        
        if (text) {
          for (const searchText of textArray) {
            if (text.includes(searchText)) {
              console.log(chalk.gray(`í…ìŠ¤íŠ¸ ë°œê²¬: "${searchText}"`));
              
              // element handleì„ selectorë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ í´ë¦­
              const box = await element.boundingBox();
              if (box) {
                // CDP í´ë¦­ ì‹œë„
                const client = await this.page.target().createCDPSession();
                
                try {
                  const x = box.x + box.width / 2;
                  const y = box.y + box.height / 2;
                  
                  await client.send('Input.dispatchMouseEvent', {
                    type: 'mousePressed',
                    x: x,
                    y: y,
                    button: 'left',
                    clickCount: 1
                  });
                  
                  await this.page.waitForTimeout(50);
                  
                  await client.send('Input.dispatchMouseEvent', {
                    type: 'mouseReleased',
                    x: x,
                    y: y,
                    button: 'left',
                    clickCount: 1
                  });
                  
                  return true;
                  
                } finally {
                  await client.detach();
                }
              }
            }
          }
        }
      }
      
      return false;
      
    } catch (error) {
      console.error(chalk.red('í…ìŠ¤íŠ¸ í´ë¦­ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * ë””ë²„ê·¸: í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œë“¤ ì¶œë ¥
   */
  async debugClickableElements() {
    try {
      const clickableElements = await this.safeEvaluate(() => {
        const elements = [];
        const all = document.querySelectorAll('div[role="link"], li[role="presentation"], button, a');
        
        for (const el of all) {
          const rect = el.getBoundingClientRect();
          const text = el.textContent?.trim().substring(0, 50);
          
          if (rect.width > 0 && rect.height > 0 && text) {
            elements.push({
              tag: el.tagName,
              text: text,
              role: el.getAttribute('role'),
              jsname: el.getAttribute('jsname'),
              dataIdentifier: el.getAttribute('data-identifier'),
              visible: el.offsetParent !== null
            });
          }
        }
        
        return elements;
      });
      
      console.log(chalk.cyan('\nğŸ“‹ í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œë“¤:'));
      clickableElements.forEach((el, index) => {
        console.log(chalk.gray(`  ${index + 1}. ${el.tag} - "${el.text}"`));
        if (el.role) console.log(chalk.gray(`     role: ${el.role}`));
        if (el.jsname) console.log(chalk.gray(`     jsname: ${el.jsname}`));
        if (el.dataIdentifier) console.log(chalk.gray(`     data-identifier: ${el.dataIdentifier}`));
      });
      
    } catch (error) {
      console.error(chalk.red('ë””ë²„ê·¸ ì‹¤íŒ¨:'), error.message);
    }
  }

  /**
   * ì´ë©”ì¼ ì…ë ¥
   */
  async enterEmail(email) {
    try {
      const emailSelectors = [
        'input[type="email"]',
        'input#identifierId',
        'input[name="identifier"]',
        'input[autocomplete="username"]'
      ];
      
      for (const selector of emailSelectors) {
        try {
          const element = await this.page.waitForSelector(selector, { 
            visible: true, 
            timeout: 3000 
          });
          
          if (element) {
            console.log(chalk.gray(`ì´ë©”ì¼ í•„ë“œ ë°œê²¬: ${selector}`));
            
            await element.click();
            await this.page.waitForTimeout(300);
            
            await this.page.keyboard.down('Control');
            await this.page.keyboard.press('a');
            await this.page.keyboard.up('Control');
            await this.page.waitForTimeout(100);
            
            await this.page.type(selector, email, { delay: 50 });
            
            console.log(chalk.green('âœ… ì´ë©”ì¼ ì…ë ¥ ì™„ë£Œ'));
            return true;
          }
        } catch (e) {
          // ë‹¤ìŒ ì„ íƒì ì‹œë„
        }
      }
      
      console.log(chalk.yellow('ì´ë©”ì¼ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ'));
      return false;
      
    } catch (error) {
      console.error(chalk.red('ì´ë©”ì¼ ì…ë ¥ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * ë‹¤ìŒ ë²„íŠ¼ í´ë¦­
   */
  async clickNextButton() {
    const buttonSelectors = [
      'button#identifierNext',
      'div#identifierNext button',
      'div#identifierNext',
      'button[jsname="LgbsSe"]'
    ];
    
    for (const selector of buttonSelectors) {
      const clicked = await this.clickHelper.clickElement(selector);
      if (clicked) {
        console.log(chalk.green('âœ… ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì„±ê³µ'));
        return true;
      }
    }
    
    return false;
  }

  /**
   * ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë‹¨ê³„ ì²˜ë¦¬
   */
  async handlePasswordStep(password) {
    try {
      await this.ensureFrameReady();
      await this.page.waitForTimeout(2000);
      
      const currentUrl = this.page.url();
      console.log(chalk.gray(`ë¹„ë°€ë²ˆí˜¸ ë‹¨ê³„ URL: ${currentUrl}`));
      
      if (!currentUrl.includes('pwd') && !currentUrl.includes('challenge') && !currentUrl.includes('password')) {
        console.log(chalk.yellow('ë¹„ë°€ë²ˆí˜¸ í˜ì´ì§€ ëŒ€ê¸°...'));
        
        try {
          await this.page.waitForFunction(
            () => window.location.href.includes('pwd') || 
                  window.location.href.includes('challenge') ||
                  window.location.href.includes('password'),
            { timeout: 5000 }
          );
        } catch (e) {
          console.log(chalk.yellow('ë¹„ë°€ë²ˆí˜¸ í˜ì´ì§€ ì „í™˜ íƒ€ì„ì•„ì›ƒ'));
        }
      }
      
      const passwordSelectors = [
        'input[type="password"]',
        'input[name="password"]',
        'input[name="Passwd"]',
        'input[autocomplete="current-password"]'
      ];
      
      let passwordEntered = false;
      
      for (const selector of passwordSelectors) {
        try {
          const element = await this.page.waitForSelector(selector, { 
            visible: true, 
            timeout: 2000 
          });
          
          if (element) {
            console.log(chalk.gray(`ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ë°œê²¬: ${selector}`));
            
            await element.click();
            await this.page.waitForTimeout(300);
            
            await this.page.type(selector, password, { delay: 50 });
            
            passwordEntered = true;
            console.log(chalk.green('âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ'));
            break;
          }
        } catch (e) {
          // ë‹¤ìŒ ì„ íƒì ì‹œë„
        }
      }
      
      if (!passwordEntered) {
        console.log(chalk.red('âŒ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ'));
        return false;
      }
      
      const loginButtonSelectors = [
        'button#passwordNext',
        'div#passwordNext button',
        'div#passwordNext',
        'button[jsname="LgbsSe"]'
      ];
      
      let buttonClicked = false;
      
      for (const selector of loginButtonSelectors) {
        const clicked = await this.clickHelper.clickElement(selector);
        if (clicked) {
          buttonClicked = true;
          console.log(chalk.green('âœ… ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì„±ê³µ'));
          break;
        }
      }
      
      if (!buttonClicked) {
        await this.page.keyboard.press('Enter');
        console.log(chalk.gray('Enter í‚¤ë¡œ ì§„í–‰'));
      }
      
      await this.page.waitForTimeout(3000);
      
      return true;
      
    } catch (error) {
      console.error(chalk.red('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * 2ë‹¨ê³„ ì¸ì¦ ì²˜ë¦¬
   */
  async handle2FAIfNeeded(credentials) {
    try {
      await this.ensureFrameReady();
      await this.page.waitForTimeout(2000);
      
      const is2FAPage = await this.safeEvaluate(() => {
        const pageText = document.body?.innerText?.toLowerCase() || '';
        return pageText.includes('2-step verification') || 
               pageText.includes('2ë‹¨ê³„ ì¸ì¦') ||
               pageText.includes('verify it\'s you') ||
               pageText.includes('ë³¸ì¸ í™•ì¸');
      });
      
      if (!is2FAPage) {
        return true;
      }
      
      console.log(chalk.yellow('ğŸ“± 2ë‹¨ê³„ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.'));
      
      const tryAnotherWay = await this.clickByText(['Try another way', 'ë‹¤ë¥¸ ë°©ë²• ì‹œë„']);
      
      if (tryAnotherWay) {
        console.log(chalk.gray('ë‹¤ë¥¸ ì¸ì¦ ë°©ë²• ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™'));
        await this.page.waitForTimeout(2000);
      }
      
      return true;
      
    } catch (error) {
      console.error(chalk.red('2ë‹¨ê³„ ì¸ì¦ ì²˜ë¦¬ ì‹¤íŒ¨:'), error.message);
      return false;
    }
  }

  /**
   * ë¡œê·¸ì¸ ì™„ë£Œ ëŒ€ê¸°
   */
  async waitForLoginComplete() {
    try {
      await this.page.waitForFunction(
        () => {
          const url = window.location.href;
          return url.includes('youtube.com') && 
                 !url.includes('accounts.google.com');
        },
        { timeout: 30000 }
      );
      
      await this.page.waitForFunction(
        () => document.readyState === 'complete',
        { timeout: 10000 }
      );
      
      await this.page.waitForTimeout(2000);
      
      return true;
      
    } catch (error) {
      console.log(chalk.yellow('ë¡œê·¸ì¸ ì™„ë£Œ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼'));
      return false;
    }
  }
  
  /**
   * reCAPTCHA ì¡´ì¬ í™•ì¸
   */
  async checkForRecaptcha() {
    try {
      await this.ensureFrameReady();
      const currentUrl = this.page.url();
      
      if (currentUrl.includes('challenge/recaptcha') || 
          currentUrl.includes('signin/v2/challenge') ||
          currentUrl.includes('challengeselection')) {
        return true;
      }
      
      const hasRecaptcha = await this.safeEvaluate(() => {
        const recaptchaFrame = document.querySelector('iframe[src*="recaptcha"]');
        if (recaptchaFrame) return true;
        
        const pageText = document.body?.innerText?.toLowerCase() || '';
        const recaptchaIndicators = [
          'recaptcha',
          'i\'m not a robot',
          'ë¡œë´‡ì´ ì•„ë‹™ë‹ˆë‹¤',
          'ë¹„ì •ìƒì ì¸ í™œë™'
        ];
        
        return recaptchaIndicators.some(text => pageText.includes(text));
      });
      
      return hasRecaptcha;
      
    } catch (error) {
      console.error(chalk.red('reCAPTCHA í™•ì¸ ì¤‘ ì˜¤ë¥˜:'), error.message);
      return false;
    }
  }
}

module.exports = GoogleLoginHelperUltimate;